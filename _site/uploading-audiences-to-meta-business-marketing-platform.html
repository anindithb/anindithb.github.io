<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><title>Guidance for Uploading Audiences created in AWS Clean Rooms to Meta Business Marketing Platform | AWS Solutions Library Samples</title><link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="shortcut icon" href="/images/aws.png"><body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-copy" viewBox="0 0 16 16"><title>Copy</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"><title>Copied</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg><div class="side-bar"><div class="site-header"> <a href="/index.html" class="site-title lh-tight"> AWS Solutions Library Samples </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a></div><nav aria-label="Main" id="site-nav" class="site-nav"><ul style="padding-right: 10px;font-weight: 600;">Guidance for Uploading Audiences created in AWS Clean Rooms to Meta Business Marketing Platform</ul><hr><ul class="nav-list"><li class="nav-list-item active"> <a href="#" class="nav-list-link">Get started</a><li class="nav-list-item active"> <a href="#overview" class="nav-list-link">Overview</a><li class="nav-list-item active"> <a href="#considerations-for-this-guidance" class="nav-list-link">Considerations for this guidance</a><li class="nav-list-item active"> <a href="#solution-architecture-for-aws-clean-rooms-activation-flow" class="nav-list-link">Solution Architecture for AWS Clean Rooms Activation flow</a><li class="nav-list-item active"> <a href="#detailed-steps-for-meta-activation-after-data-collaboration" class="nav-list-link">Detailed steps for Meta activation after data collaboration</a><li class="nav-list-item active"> <a href="#conclusion" class="nav-list-link">Conclusion</a><li class="nav-list-item active"> <a href="#notices" class="nav-list-link">Notices</a></ul><ul class="nav-list"></ul></nav></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search AWS Solutions Library Samples" aria-label="Search AWS Solutions Library Samples" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="//github.com/just-the-docs/just-the-docs" class="site-button" > Just the Docs on GitHub </a></ul></nav></div><div id="main-content-wrap" class="main-content-wrap"><div id="main-content" class="main-content" role="main"><div class="post-header"><h1 class="post-title-main"> Guidance for Uploading Audiences created in AWS Clean Rooms to Meta Business Marketing Platform</h1></div><p class=".fs-6 .fw-300"> <b>Summary:</b> This Guidance demonstrates how AWS Clean Rooms can help marketers and data engineers activate audience segments on the Meta Business Marketing platform.</p><hr /><h2 id="overview"> <a href="#overview" class="anchor-heading" aria-labelledby="overview"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Overview</h2><p>Today, marketers have plenty of options when it comes to audience targeting and intelligence solutions in the form of Software as a Service (SaaS). Increasingly, first party data in an enterprise are being siloed because of on-premise, public cloud, and SaaS implementation models for business applications.</p><p>With these enterprise data siloes and the need for multiple data providers get the right marketing intelligence, marketers are faced with the difficulty in bringing data together in a privacy compliant way.</p><p>AWS Clean Rooms service is a data collaboration tool that helps marketers bring data together from various data providers and publishers and match it against their first party data in a fast, privacy compliant fashion. AWS Clean Rooms allows this to be done with minimum data movement. </p><p>One of the common outcomes for an advertiser from the data collaboration is a list of customers who need to be targeted on leading publishing platforms like Meta, Amazon Ads, Snap, and TikTok. This document serves as a solution guidance for marketers and data engineers to activate their audiences on Meta Business Marketing platform. </p><p>Meta has multiple properties under their brand for advertisers to use. This solution focuses and on Facebook Marketing API. The strategies mentioned here could be used for other meta properties like Instagram Ads API.</p><h2 id="considerations-for-this-guidance"> <a href="#considerations-for-this-guidance" class="anchor-heading" aria-labelledby="considerations-for-this-guidance"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Considerations for this guidance</h2><ol><li><p>Intended audience is existing AWS customers with an active account and have already engaged in a data collaboration using AWS Clean Rooms service.</p><li><p>AWS Clean Rooms service is used by a marketing analyst or data engineer to create an audience list using the SQL query and export capability which comes out of the box in the AWS Clean Rooms service</p><li><p>User personas who are implementing this solution guidance are data engineers in marketing or a central data team. </p><li><p>Each run of the data pipeline uploads a new list of audience data. Updates to existing audience list and de-duplication is expected to be handled by the Publisher (Meta) API</p><li><p>The solution accelerates deployment of the services needed to create an activation data pipeline. Example data transformations will also be provisioned. </p><li><p>Expectation is that customers can customize the services and transformation logic provisioned in their account by the solution to meet their specific needs.</p></ol><h2 id="solution-architecture-for-aws-clean-rooms-activation-flow"> <a href="#solution-architecture-for-aws-clean-rooms-activation-flow" class="anchor-heading" aria-labelledby="solution-architecture-for-aws-clean-rooms-activation-flow"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Solution Architecture for AWS Clean Rooms Activation flow</h2><figure><img class="docimage" src="images/Meta/meta_figure1.png" alt="" /></figure><p><em>Figure 1 - Diagram for AWS Clean Rooms activation flow</em></p><h2 id="detailed-steps-for-meta-activation-after-data-collaboration"> <a href="#detailed-steps-for-meta-activation-after-data-collaboration" class="anchor-heading" aria-labelledby="detailed-steps-for-meta-activation-after-data-collaboration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Detailed steps for Meta activation after data collaboration</h2><p>The proposed solution for activation on Facebook Marketing API uses Amazon S3, AWS Glue, Amazon EventBridge, AWS Secrets Manager, and AWS Lambda services. These services are put together in the solution for collecting the output of AWS Clean Rooms collaboration, normalizing, and delivering data to the Meta ads platform based on their API contracts. </p><p>For demonstration purposes, this solution is using the Conversion API within the Meta ads platform. Please refer to Meta <a href="https://developers.facebook.com/docs/marketing-api/conversions-api/parameters/customer-information-parameters" target="_blank">documentation</a> for data normalization requirements. There are several ways to <a href="https://www.facebook.com/business/help/433493041367251?id=818859032317965" target="_blank">setup</a> the Conversions API. The <a href="https://www.facebook.com/business/help/232481544843294?id=818859032317965" target="_blank">Direct integration using code</a> approach is used here.</p><p>The solution also uses Facebook’s <a href="https://developers.facebook.com/docs/business-sdk/overview" target="_blank">Business Software Development Kit</a> (SDK) in Python for building the integration. Use of SDK abstracts the hashing/pseudo-anonymizing Personally Identifiable Information (PII).</p><h3 id="prerequisites"> Prerequisites</h3><p>For setting up this solution, you will need access to the following beforehand:</p><ul><li><p>A <a href="https://developers.facebook.com/docs/apps#register" target="_blank">Facebook Developer Account</a></p><li><p>A <a href="https://developers.facebook.com/docs/apps#app-id" target="_blank">registered</a> Facebook App with Basic settings configured</p><li><p>A <a href="https://developers.facebook.com/docs/facebook-login/access-tokens/" target="_blank">Page Access Token</a>:</p></ul><figure><img class="docimage" src="images/Meta/meta_figure2.jpg" alt="" /></figure><p><em>Figure 2 - Image of the settings tab where you’ll find the token</em></p><ul><li>AWS Secrets Manager secret (you can create the secret in following steps)</ul><h3 id="solution-setup-instructions"> Solution Setup instructions</h3><h4 id="high-level-steps"> High Level Steps</h4><p>The solution setup consists of these high-level steps:</p><ol><li><p>AWS Identity and Access Management (IAM) setup using AWS IAM service</p><li><p>AWS Key Management Store (AWS KMS) setup for encryption keys using AWS KMS service</p><li><p>App secret and configuration setup using AWS Secrets Manager/AWS System Manager Parameter store service</p><li><p>Data Storage setup in Amazon S3 service</p><li><p>Data Transformation job setup using AWS Glue service</p><li><p>Event handling setup using Amazon EventBridge and AWS Simple Queue Service (SQS) service</p><li><p>Facebook data publish setup using AWS Lambda service</p></ol><p>These steps are in more detail below:</p><h4 id="detailed-instructions"> Detailed instructions</h4><h3 id="iam-setup"> IAM Setup</h3><p><strong>Step 1: Create a new IAM role that would be used for the build of this solution. This role is assumed by the AWS services that need access to other AWS services.</strong></p><ol><li><p>Navigate to <strong>Access Management</strong> → <strong>Roles</strong> → <strong>Create role</strong></p><li><p>Keep Trusted entity type as <strong>AWS Service</strong></p><li><p>Select <strong>Lambda</strong> as the Use case and select <strong>next</strong>. We are starting with Lambda but could add more as needed</p><li><p>In the Add permissions page, search and use the below permissions:</p><ul><li><p><code class="language-plaintext highlighter-rouge">AWSLambdaBasicExecutionRole</code></p><li><p><code class="language-plaintext highlighter-rouge">AWSGlueServiceRole</code></p><li><p>Create an inline policy with the policy statement below to give the role read access to Amazon S3, KMS, System Manager services and resources under them. Substitute bucket name, region, account, key id, and parameter values with real ones:</p></ul></ol><div style="counter-reset:none" class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CleanRoomActivationS3Access"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"s3:PutObject"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"s3:GetObject"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"s3:ListBucket"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"s3:DeleteObject"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"s3:GetBucketLocation"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"s3:ListMultipartUploadParts"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"arn:aws:s3:::&lt;bucket name&gt;/*"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"arn:aws:s3:::&lt;bucket name&gt;"</span><span class="w">
            </span><span class="p">]</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CleanRoomActivationKMSAccess"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"kms:Describe*"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"kms:Get*"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"kms:List*"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"kms:Decrypt"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"kms:Encrypt"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"kms:GenerateDataKey"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:kms:&lt;region&gt;:&lt;account&gt;:key/&lt;key id&gt;"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CleanRoomActivationSSMAccess"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"ssm:GetParameter*"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:ssm:&lt;region&gt;:&lt;account id&gt;:parameter/&lt;parameter path&gt;*"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">

</span></code></pre></div></div><ol><li><p>Enter name, description and tags and create role.</p><li><p>Open the newly created role and navigate to the <strong>Trust relationships</strong> tab. </p><li><p>Edit the trust policy to include the below trust relationships to let multiple services assume this role:</p></ol><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"Service"</span><span class="p">:</span><span class="w"> </span><span class="s2">"lambda.amazonaws.com"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts:AssumeRole"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"Service"</span><span class="p">:</span><span class="w"> </span><span class="s2">"glue.amazonaws.com"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts:AssumeRole"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><ol style="counter-reset:none"><li>Keep the ARN of the role handy for future use</ol><h3 id="aws-key-management-service-aws-kms-setup"> AWS Key Management Service (AWS KMS) Setup</h3><p><strong>Step 2: Create a new AWS KMS Key</strong></p><ol><li><p>Navigate to the AWS KMS console and select on <strong>Create Key</strong></p><li><p>Keep <strong>Symmetric</strong> as Key Type and <strong>Encrypt and decrypt</strong> as key usage and select <strong>next</strong></p><li><p>Enter name, description and tags, and click next</p><li><p>Keep all other settings as default and create the key. Keep the Key id and ARN handy for future use</p></ol><h3 id="secrets-and-configuration-storage"> Secrets and configuration storage</h3><p><strong>Step 3: Store access token from Meta Pixel setup in either AWS Secrets manager or AWS System Manager Parameter Store</strong></p><p>If using AWS Secrets manager for storing secrets, follow below steps:</p><ol><li><p>On the Secrets Manager console, choose <strong>Store a new secret</strong>.</p><li><p>For Secret type, select <strong>Other</strong></p><li><p>Enter your key as credentials and the value as the <strong>base64-encoded string</strong>.</p><li><p>Leave the rest of the options at their default.</p><li><p>Choose <strong>Next</strong>.</p><li><p>Give a name to the secret following a URI format to make it easier to find it amongst multiple secrets in the<code class="language-plaintext highlighter-rouge">/dev/cleanroom-activations/meta/conversions/access_token.</code></p><li><p>Follow through the rest of the steps to store the secret.</p></ol><p>If using AWS System Manager Parameter Store for storing secrets and other configurations, follow the steps below:</p><ol><li><p>On the System Manager console, navigate to <strong>Application Management</strong> → <strong>Parameter Store</strong> and select <strong>Create parameter</strong></p><li><p>Enter parameter name in a URI format. For example,<code class="language-plaintext highlighter-rouge"> /dev/cleanroom-activations/meta/conversions</code></p><li><p>Enter a description, keep Tier as <strong>Standard</strong> and choose <strong>SecureString</strong> as Type</p><li><p>Select an AWS KMS key to encrypt the secret. Use Customer Managed Key as a best practice. Create a new one for the project if needed as it can be used for encryption of data throughout the data pipeline</p><li><p>Keep datatype as text and into the value input enter the json string below. Fill in the <code class="language-plaintext highlighter-rouge">access_token</code> and <code class="language-plaintext highlighter-rouge">pixel_id</code> values:</p></ol><div style="counter-reset:none" class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"access_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="nl">"pixel_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
</span><span class="p">}</span><span class="w">

</span></code></pre></div></div><ol style="counter-reset:none"><li>Enter tags and click on create parameter</ol><h3 id="data-storage-setup"> Data storage setup</h3><p><strong>Step 4: Create two Amazon S3 buckets, one for storing output of AWS Clean Rooms collaboration export query and another for storing output of the AWS Glue data transformation job</strong></p><ol><li><p>Navigate to Amazon S3 console</p><li><p>Choose <strong>Create bucket</strong></p><li><p>Provide a globally unique bucket name</p><li><p>Choose the appropriate region</p><li><p>Block public access</p><li><p>Enable Bucket Versioning</p><li><p>Enable SSE-S3 based bucket encryption</p><li><p>Provide appropriate tag(s)</p><li><p>Create bucket and repeat the process for the second one</p></ol><h3 id="data-transformation-setup"> Data transformation setup</h3><p><strong>Step 5: Create an AWS Glue job that reads from export bucket and generates activation output files. Create multiple files:</strong></p><ol><li><p>Navigate to <strong>AWS Glue studio</strong> console → <strong>Data Integration</strong> and <strong>ETL</strong> → <strong>AWS Glue</strong> Studio → <strong>Jobs</strong></p><li><p>On the create job page keep <strong>Visual with source and target</strong> option and keep source and target as <strong>Amazon S3</strong> and select <strong>create</strong></p><li><p>On the AWS Glue studio canvas go to <strong>Job Details</strong></p><li><p>Add a name, select the new IAM role created earlier</p><li><p>Select <strong>Server-side encryption</strong> in Advanced options and keep all other configurations default</p><li><p>Click <strong>save</strong> on the top right corner of console</p><li><p>Go back to the canvas and click on the <strong>Source s3</strong> node.</p><p>a. Select the s3 bucket and folder where data collaboration output will be stored</p><p>b. It’s assumed at this point that the output of the AWS Clean Rooms export may have multiple files having the same structure and the AWS Glue job is expected to read all of them when run</p><p>c. In this example, it’s assumed that output file is a CSV with “,” as delimiter</p><p>d. Choose <strong>escape</strong>, <strong>Quote</strong> and column header options accordingly</p></ol><blockquote class="highlight-title"><p>tips</p><ol><li>Use data preview option to ensure data is being read correctly<li>AWS Glue requires input file to be encoded in utf8. If input file is not utf8 encoded, refer this page for potential solutions for converting</ol></blockquote><ol style="counter-reset:none"><li><p>Remove the <strong>ApplyMapping</strong> node</p><li><p>Add a new SQL query to transform node and select source s3 bucket as parent. We will come back to this transform node to finish the setup</p><li><p>Select target s3 node and change the node parent to the SQL transform node</p><li><p>Go to <strong>Data target properties</strong> tab and select the Amazon S3 target location. Keep all other configurations as default and save the job using the button on the top right corner of the console</p></ol><p>Once all the steps are validated, AWS Glue gives you an option to preview data. At this point doing that validation, it is a good idea to visualize data output in each step:</p><figure><img class="docimage" src="images/Meta/meta_figure3.png" alt="" /></figure><p><em>Figure 3 - Visualization of data output in each step</em></p><p><strong>Event handling setup</strong></p><ol><li><p>Create a new dummy lambda function. This step is just to have a reference point available to update the EventBridge rule. Once the integration is done and tested on a high level, you will be coming back and updating this function to include more logic</p><li><p>Create an Amazon Simple Queue Service (Amazon SQS) queue that would act as a dead letter queue for s3 upload events</p><p>a. Navigate to Amazon SQS console and select <strong>Create queue</strong></p><p>b. Keep Type as <strong>Standard</strong> and give a name for the queue. Suffix <strong>DLQ</strong> to notate that this queue acts as a dead letter queue</p><p>c. Keep the configuration settings as is</p><p>d. In the <strong>Access policy</strong> card, keep the <strong>Basic</strong> selection on. </p><p>e. Give permission to the IAM role created earlier to send and receive messages from this queue by entering the ARN of the role in the input field</p><p>f. Keep all other configurations as default. Encryption at rest is optional because this queue will not be storing sensitive data. It will be storing only the metadata about objects created in the s3 bucket</p><p>g. Add tags as needed and create the queue. Keep the ARN of the queue handy for future reference</p></ol><ol style="counter-reset:none"><li>Create an Amazon EventBridge rule on the <strong>default event bus</strong></ol><p><strong>Create a new rule:</strong></p><p>            a. From the Amazon EventBridge Console navigate to <strong>Events</strong> → <strong>Rules</strong>.</p><p>            b. Enter Name, Description and keep <strong>default</strong> selected in Event bus option</p><p>            c. Keep <strong>Rule with an event pattern</strong> selected and click next</p><p>            d. Select <strong>AWS Events</strong> as Event Source</p><p>            e. Skip <strong>Sample event</strong> card and scroll down to <strong>Event Pattern</strong></p><p>            f. Select <strong>Custom patterns</strong> that allows you to enter the pattern as a json</p><p>            g. Edit json below to update the <code class="language-plaintext highlighter-rouge">bucket.name</code> and <code class="language-plaintext highlighter-rouge">object.key.prefix</code> key value pairs and paste in the json editor</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"aws.s3"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"detail-type"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"Object Created"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"detail"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"bucket"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"cleanroom-activations"</span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"object"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
        </span><span class="nl">"prefix"</span><span class="p">:</span><span class="w"> </span><span class="s2">"meta/"</span><span class="w">
      </span><span class="p">}]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p>            h. Ensure that json is valid and select <strong>next</strong></p><p>            i. Select <strong>AWS service</strong> as target and select the newly created lambda function</p><p>            j. Keep all the other settings as defaults except for retry attempts and dead-letter queue option</p><p>            k. For retry attempts change the value to <strong>3</strong></p><p>            l. Select the newly created Amazon SQS queue from the drop down and select <strong>next</strong></p><p>            m. Add tags as required and select <strong>next</strong></p><p>            n. Review the configurations and select <strong>create button</strong> to complete rule creation.</p><ol style="counter-reset:none"><li>Create an event bus archive to persist events specific to the file upload and for replay capability</ol><p><strong>Facebook data publish setup</strong></p><ol><li><p>Update the Lambda function and include logic to read the files and send it to Meta API</p><ul><li><p>Clone <a href="https://github.com/aws-samples/activation-connector-meta-business" target="_blank">sample code</a> from repo and change it to meet your needs. Paste the code in to the Lambda code editor.</p><li><p>Add two dependency layers to the Lambda function following referenced documentations <a href="https://aws-sdk-pandas.readthedocs.io/en/stable/install.html#:~:text=Managed%20Layer" target="_blank">AWS Data Wrangler</a> and <a href="https://aws.amazon.com/premiumsupport/knowledge-center/lambda-import-module-error-python/" target="_blank">Facebook Business</a></p></ul><li><p>Use Python 3.9 where ever Python 3.8 is referenced in the above instruction</p><li><p>Use facebook_business as the module name in pip install</p><li><p>Give FacebookBusiness-Python39 as the layer name</p><p>a. While using <a href="https://aws-sdk-pandas.readthedocs.io/en/stable/index.html" target="_blank">AWS Data Wrangler</a> package use “chunksize” option reading s3 files</p><p>b. Use Meta Python Business SDK to build the payload and send data to the platform</p><p>c. Upload a sample file to the s3 bucket created and test the lambda function using a sample event payload. Replace bucket and object name with real bucket and object name so that the function can access the file to read data:</p></ol><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2d4eba74-fd51-3966-4bfa-b013c9da8ff1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"detail-type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Object Created"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="s2">"aws.s3"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"account"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123456789012"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"time"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2021-11-13T00:00:59Z"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"region"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-east-1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"resources"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"arn:aws:s3:::&lt;bucket name&gt;"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"detail"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"bucket"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;bucket name&gt;"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"object"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;object name&gt;"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">99797</span><span class="p">,</span><span class="w">
            </span><span class="nl">"etag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"7a72374e1238761aca7778318b363232"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"version-id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"a7diKodKIlW3mHIvhGvVphz5N_ZcL3RG"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"sequencer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00618F003B7286F496"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"request-id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"4Z2S00BKW2P1AQK8"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"requester"</span><span class="p">:</span><span class="w"> </span><span class="s2">"348414629041"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"source-ip-address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"72.21.198.68"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"reason"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PutObject"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p>Successful execution should show results similar to below:</p><figure><img class="docimage" src="images/Meta/meta_figure4.png" alt="" /></figure><p><em>Figure 4 - Successful execution should show results similar to image above</em></p><p>d. Test the end-to-end flow starting from file upload.</p><p>e. Validate data in Meta platform using the Events Manager portal</p><figure><img class="docimage" src="images/Meta/meta_figure5.png" alt="" /></figure><p><em>Figure 5 - Image of Events Manager portal</em></p><h3 id="scheduling-and-other-operational-procedures"> Scheduling and other operational procedures</h3><p>Here are some considerations for ongoing maintenance and support of the solution</p><ol><li><p>AWS Glue comes with a scheduler functionality that can be used to schedule jobs at a regular cadence. Use this for recurring jobs. </p><li><p>Use Amazon CloudWatch service for viewing execution logs and visualizations for troubleshooting. </p><li><p>Since the source of data for this integration is generated in a batch mode, re-running of failed batches could end up sending duplicate data into the activation channels and it’s assumed that the activation channel API’s are able to handle it. </p><li><p>To avoid duplications, e-running the data collaboration query by restricting the records exported is recommended.</p><li><p>Amazon EventBridge event replay feature could be used to re-run batches without the need for recreating the files, </p><li><p>Implement Amazon S3 bucket lifecycle policies to keep data secure</p></ol><h3 id="performance-considerations"> Performance Considerations</h3><p>Proposed solution implements below for performance optimization techniques</p><ol><li><p>Data output from AWS Clean Rooms Clean Rooms data collaboration and AWS Glue transform job stage should be stored in multiple files.</p><li><p>Read data in chunks of predefined size from each file in the AWS Lambda function</p></ol><p>These measures provide the following benefits:</p><ol><li><p>Publisher API request can be batched up with multiple rows, reducing the risk of hitting Publisher API rate limits.</p><li><p>Memory utilization of Lambda can be minimized</p></ol><h3 id="customer-list-custom-audiences-api"> Customer List Custom Audiences API</h3><p>For activation purposes, customers should be using the <a href="https://developers.facebook.com/docs/marketing-api/audiences/guides/custom-audiences" target="_blank">Customer List Custom Audiences API</a>. Setting up your Meta account to receive custom customer lists should be done in consultation with your Meta Business Marketing point of contact(s). </p><p>Once the Meta app and Ad account setup is done, follow the steps below to repoint your pipeline to hit the Custom Audiences API</p><ol><li><p>Create a new the AWS Lambda function that connects to the Custom Audiences API. </p><li><p>Update EventBridge rule to call the new Lambda function</p></ol><h3 id="data-transformation--alternatives"> Data Transformation – Alternatives</h3><p>The AWS glue job that does the transformation/normalization of data can be substituted with an AWS Glue DataBrew job. DataBrew service is a no code solution to build your data transformation logic. The data transformation code is stored as a re-usable recipe. A published recipe is then used in a DataBrew job to generate output.</p><h2 id="conclusion"> <a href="#conclusion" class="anchor-heading" aria-labelledby="conclusion"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Conclusion</h2><p>The reference architecture provided here addresses the need for activation of audiences on multiple publisher platforms. The detailed guidance provides the steps needed to activate on Meta which can be used as a template for adding new publishing channels. The main difference in the activation flow for other platforms like Snapchat and TikTok would be on the Lambda code that connects to the publisher API as well as their unique data transformation needs.</p><h2 id="notices"> <a href="#notices" class="anchor-heading" aria-labelledby="notices"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Notices</h2><p>Meta and Facebook are trademarks of Meta Platforms, Inc. or its affiliates.</p><hr><footer><p><a href="#top" id="back-to-top">Back to top</a></p></footer></div></div><div class="search-overlay"></div></div>

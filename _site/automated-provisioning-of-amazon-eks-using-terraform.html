<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><title>Guidance for Automated Provisioning of Amazon Elastic Kubernetes Service (EKS) using Terraform Implementation Guide | AWS Solutions Library Samples</title><link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="shortcut icon" href="/images/aws.png"><body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-copy" viewBox="0 0 16 16"><title>Copy</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"><title>Copied</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg><div class="side-bar"><div class="site-header"> <a href="/index.html" class="site-title lh-tight"> AWS Solutions Library Samples </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a></div><nav aria-label="Main" id="site-nav" class="site-nav"><ul style="padding-right: 10px;font-weight: 600;">Guidance for Automated Provisioning of Amazon Elastic Kubernetes Service (EKS) using Terraform Implementation Guide</ul><hr><ul class="nav-list"><li class="nav-list-item active"> <a href="#" class="nav-list-link">Get Started</a><li class="nav-list-item active"> <a href="#introduction" class="nav-list-link">Introduction</a><li class="nav-list-item active"> <a href="#what-are-eks-blueprints" class="nav-list-link">What are EKS Blueprints?</a><li class="nav-list-item active"> <a href="#core-concepts" class="nav-list-link">Core Concepts</a><li class="nav-list-item active"> <a href="#node-groups" class="nav-list-link">Node Groups</a><li class="nav-list-item active"> <a href="#iam-policies-and-roles" class="nav-list-link">IAM Policies and Roles</a><li class="nav-list-item active"> <a href="#teams-1" class="nav-list-link">Teams</a><li class="nav-list-item active"> <a href="#kubernetes-add-ons-modules" class="nav-list-link">Kubernetes Add-ons Modules</a><li class="nav-list-item active"> <a href="#updating-managed-add-ons" class="nav-list-link">Updating Managed Add-ons</a><li class="nav-list-item active"> <a href="#running-new-vpc-eks-terraform-blueprint" class="nav-list-link">Running new VPC EKS Terraform Blueprint</a><li class="nav-list-item active"> <a href="#running-argo-cd-eks-terraform-blueprint" class="nav-list-link">Running Argo CD EKS Terraform Blueprint</a><li class="nav-list-item active"> <a href="#running-apache-spark-on-eks-terraform-blueprint" class="nav-list-link">Running Apache Spark on EKS Terraform Blueprint</a><li class="nav-list-item active"> <a href="#support-and-troubleshooting" class="nav-list-link">Support and Troubleshooting</a></ul><ul class="nav-list"></ul></nav></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search AWS Solutions Library Samples" aria-label="Search AWS Solutions Library Samples" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="//github.com/just-the-docs/just-the-docs" class="site-button" > Just the Docs on GitHub </a></ul></nav></div><div id="main-content-wrap" class="main-content-wrap"><div id="main-content" class="main-content" role="main"><div class="post-header"><h1 class="post-title-main"> Guidance for Automated Provisioning of Amazon Elastic Kubernetes Service (EKS) using Terraform Implementation Guide</h1></div><p class=".fs-6 .fw-300"> <b>Summary:</b> Use EKS Bluprints to deploy Amazon Elastic Kubernetes Service (EKS) with HashiCorp Terraform Open Source software.</p><hr /><h2 id="introduction"> <a href="#introduction" class="anchor-heading" aria-labelledby="introduction"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Introduction</h2><p>This user guide is for anyone interested in efficiently deploying Amazon Elastic Kubernetes Service (EKS) that complements open-source documentation for EKS Blueprints, available in the <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform" target="_blank">AWS Solutions Library open-source GitHub repository</a>. It introduces common concepts, specific details for configuration of EKS for selected use cases, and step-by-step instructions on how to deploy that EKS Blueprint using <a href="https://www.terraform.io/" target="_blank">HashiCorp Terraform</a> Open Source Infrastructure as Code (IaC) automation software.</p><p>By following this guide, you will be able to:</p><ul><li><p>Familiarize yourself with the concepts of EKS Blueprints</p><li><p>Learn ways to customize those Blueprints through parameters</p><li><p>Deploy an Amazon EKS cluster with a new Amazon Virtual Private Cloud (Amazon VPC)</p><li><p>Deploy an Amazon EKS cluster with operational software and <a href="https://argo-cd.readthedocs.io/en/stable/core_concepts/" target="_blank">Argo CD</a>, a GitOps tool used for deployment of both add-on components and applications, into an Amazon EKS cluster</p><li><p>Deploy an Amazon EKS cluster with <a href="https://spark.apache.org/" target="_blank">Apache Spark</a> and other related add-ons for data analytics</p><li><p>If needed: properly clean-up and destroy an Amazon EKS cluster deployment provisioned using an EKS Blueprint</p></ul><p>Finally, there are tips on support and troubleshooting at the end of this guide.</p><h2 id="what-are-eks-blueprints"> <a href="#what-are-eks-blueprints" class="anchor-heading" aria-labelledby="what-are-eks-blueprints"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> What are EKS Blueprints?</h2><p>EKS Blueprints help you compose complete <a href="https://aws.amazon.com/eks/" target="_blank">EKS clusters</a> that are fully bootstrapped with operational software that is needed to deploy and operate application workloads. With EKS Blueprints, you describe the configuration of a desired state of your EKS environment, such as control plane, compute plane (worker nodes), and Kubernetes add-ons, as an Infrastructure as a Code (IaC) blueprint. Once an EKS Blueprint is configured, you can use it to stamp out consistent EKS environments across multiple AWS accounts and Regions using continuous deployment automation.</p><p>You can utilize EKS Blueprints to easily bootstrap an EKS cluster with Amazon EKS add-ons as well as a wide range of popular open-source add-ons, including Prometheus, Karpenter, Nginx, Traefik, AWS Load Balancer Controller, Fluent Bit, KEDA, Argo CD (GitOps), <a href="https://spark.apache.org/" target="_blank">Apache Spark</a> and more. EKS Blueprints also help to implement relevant security controls needed to operate workloads from multiple teams in the same cluster.</p><h2 id="core-concepts"> <a href="#core-concepts" class="anchor-heading" aria-labelledby="core-concepts"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Core Concepts</h2><p>Below is a high-level overview of the Core Concepts that are incorporated into EKS Blueprints. It is assumed the reader is familiar with Git, Docker, Kubernetes, and AWS.</p><div class="table-wrapper"><table><thead><tr><th>Concept<th>Description<tbody><tr><td>Cluster<td>An Amazon EKS Cluster and associated worker groups.<tr><td>Add-ons<td>Operational software that provides key functionality to support your Kubernetes applications.<tr><td>Teams<td>A logical grouping of AWS Identity and Access Management (IAM) identities that have access to Kubernetes resources.<tr><td>Pipeline<td>Continuous Delivery pipelines for deploying <code class="language-plaintext highlighter-rouge">clusters</code> and <code class="language-plaintext highlighter-rouge">add-ons</code><tr><td>Application<td>An application that runs within an EKS Cluster.</table></div><h3 id="cluster"> Cluster</h3><p>A <code class="language-plaintext highlighter-rouge">cluster</code> is an Amazon <a href="https://aws.amazon.com/eks/" target="_blank">EKS cluster</a>. EKS Blueprints provide customized compute options you can apply to your clusters. The framework currently supports <a href="https://aws.amazon.com/ec2/" target="_blank">Amazon Elastic Compute Cloud</a> (Amazon EC2) and <a href="https://aws.amazon.com/fargate/" target="_blank">AWS Fargate</a> instances for compute plane nodes. It also supports managed and self-managed Node groups. To specify the type of compute you want to use for your cluster, you can utilize the <code class="language-plaintext highlighter-rouge">managed_node_groups,self_managed_nodegroups</code> or <code class="language-plaintext highlighter-rouge">fargate_profiles</code> Terraform variables.</p><p>See our <a href="#node-groups">Node Groups</a> documentation for more detail.</p><h3 id="add-ons"> Add-ons</h3><p><code class="language-plaintext highlighter-rouge">Add-ons</code> allow you to configure operational tools you want to deploy into your EKS clusters. When you configure <code class="language-plaintext highlighter-rouge">add-ons</code> for a <code class="language-plaintext highlighter-rouge">cluster</code>, those <code class="language-plaintext highlighter-rouge">add-ons</code> will be provisioned at deploy time by the <a href="https://registry.terraform.io/providers/hashicorp/helm/latest/docs" target="_blank">Terraform Helm provider</a>. <code class="language-plaintext highlighter-rouge">Add-ons</code> can deploy both Kubernetes specific resources and AWS resources needed to support add-on functionality.</p><p>For example, the <code class="language-plaintext highlighter-rouge">metrics-server</code> add-on only deploys the Kubernetes manifests that are needed to run the Kubernetes Metrics Server. By contrast, the <code class="language-plaintext highlighter-rouge">aws-load-balancer-controller</code> add-on deploys both Kubernetes YAML, in addition to creating resources through AWS APIs that are needed to support the AWS Load Balancer Controller functionality.</p><p>EKS Blueprints allow you to manage cluster add-ons directly through Terraform (by using the Terraform Helm provider) or through GitOps processes with <a href="https://argo-cd.readthedocs.io/en/stable" target="_blank">Argo CD</a>. See <a href="#kubernetes-add-ons-modules">Add-ons</a> documentation section for detailed information.</p><h3 id="teams"> Teams</h3><p><code class="language-plaintext highlighter-rouge">Teams</code> allow you to configure the logical grouping of users that have access to your EKS clusters, in addition to the access permissions they are granted. EKS Blueprints currently supports two types of <code class="language-plaintext highlighter-rouge">teams</code>: <code class="language-plaintext highlighter-rouge">application-team</code> and <code class="language-plaintext highlighter-rouge">platform-team</code>. <code class="language-plaintext highlighter-rouge">application-team</code> members are granted access to specific namespaces, <code class="language-plaintext highlighter-rouge">platform-team</code> members are granted administrative access to clusters.</p><p>See our <a href="https://aws-ia.github.io/terraform-aws-eks-blueprints/teams/" target="_blank">Teams</a> documentation page for detailed information.</p><h3 id="application"> Application</h3><p><code class="language-plaintext highlighter-rouge">Applications</code> represent the actual workloads that run within a Kubernetes cluster. The framework leverages a GitOps approach for deploying applications onto clusters.</p><p>See <a href="https://aws-ia.github.io/terraform-aws-eks-blueprints/add-ons/argocd/#boostrapping" target="_blank">Applications</a> documentation for detailed information.</p><h2 id="node-groups"> <a href="#node-groups" class="anchor-heading" aria-labelledby="node-groups"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Node Groups</h2><p>The framework uses dedicated submodules for creating <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/tree/main/modules/aws-eks-managed-node-groups" target="_blank">AWS Managed Node Groups</a>, <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/tree/main/modules/aws-eks-self-managed-node-groups" target="_blank">Self-managed Node groups</a> and <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/tree/main/modules/aws-eks-fargate-profiles" target="_blank">Fargate profiles</a>. These modules provide flexibility to add or remove managed/self-managed compute node groups or Fargate profiles by simply adding or removing a map of values to input config. See <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/tree/main/examples/eks-cluster-with-new-vpc" target="_blank">example</a>.</p><p>The <code class="language-plaintext highlighter-rouge">aws-auth</code> ConfigMap handled by this module allows nodes to join your cluster, and you can also use this ConfigMap to add role-based access control (RBAC) to AWS Identity and Access Management (IAM) users and roles. Each node group can have a dedicated IAM role, Launch template, and Security Group to improve the security.</p><h3 id="additional-iam-roles-users-and-accounts"> Additional IAM Roles, Users and Accounts</h3><p>Access to EKS clusters using AWS IAM entities is enabled by the <a href="https://github.com/kubernetes-sigs/aws-iam-authenticator/blob/master/README.md" target="_blank">AWS IAM Authenticator</a> for Kubernetes, which runs on the Amazon EKS control plane. The authenticator gets its configuration information from the <code class="language-plaintext highlighter-rouge">aws-auth</code> <a href="https://kubernetes.io/docs/concepts/configuration/configmap/" target="_blank">ConfigMap</a>.</p><p>The following config grants additional AWS IAM users or roles an ability to interact with your cluster. However, the best practice is to leverage <a href="https://aws.github.io/aws-eks-best-practices/security/docs/multitenancy/" target="_blank">soft-multitenancy</a> with the help of the <a href="#teams">Teams</a> module. The Teams feature helps to manage users with dedicated Kubernetes (also known as K8s) namespaces, RBAC, IAM roles, and registers them with <code class="language-plaintext highlighter-rouge">aws-auth</code> to provide access to the EKS Cluster.</p><p>The example below demonstrates adding IAM Roles, IAM Users, and Accounts using the <strong>EKS Blueprints</strong> module. An example of a source code file relevant to this Guidance where those changes can be made can be found <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/blob/main/docs/node-groups.md" target="_blank">here</a>.</p><div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="s2">"eks_blueprints"</span> <span class="p">{</span>
    <span class="nx">source</span> <span class="p">=</span> <span class="s2">"github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform"</span>
    <span class="c1"># EKS CLUSTER PARAMETERS</span>
    <span class="nx">cluster_version</span> <span class="p">=</span> <span class="s2">"1.24"</span> <span class="c1"># EKS K8s Version</span>
    <span class="nx">vpc_id</span> <span class="p">=</span> <span class="s2">"&lt;vpcid&gt;"</span> <span class="c1"># Enter VPC ID</span>
    <span class="nx">private_subnet_ids</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"&lt;subnet-a&gt;"</span><span class="p">,</span> <span class="s2">"&lt;subnet-b&gt;"</span><span class="p">,</span> <span class="s2">"&lt;subnet-c&gt;"</span><span class="p">]</span> <span class="c1"># Enter Private Subnet IDs</span>

    <span class="c1"># List of map_roles</span>
    <span class="nx">map_roles</span> <span class="p">=</span> <span class="p">[</span>
        <span class="p">{</span>
        <span class="nx">rolearn</span> <span class="p">=</span> <span class="s2">"arn:aws:iam::&lt;aws-account-id&gt;:role/&lt;role-name&gt;"</span> <span class="c1"># The ARN of the IAM role</span>
        <span class="nx">username</span> <span class="p">=</span> <span class="s2">"ops-role"</span> <span class="c1"># The user name within Kubernetes to map to the IAM role</span>
        <span class="nx">groups</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"system:masters"</span><span class="p">]</span> <span class="c1"># A list of groups within Kubernetes to which the role is mapped; Checkout K8s Role and RoleBindings</span>
        <span class="p">}</span>
    <span class="p">]</span>

    <span class="c1"># List of map_users</span>
    <span class="nx">map_users</span> <span class="p">=</span> <span class="p">[</span>
        <span class="p">{</span>
        <span class="nx">userarn</span> <span class="p">=</span> <span class="s2">"arn:aws:iam::&lt;aws-account-id&gt;:user/&lt;username&gt;"</span> <span class="c1"># The ARN of the IAM user to add.</span>
        <span class="nx">username</span> <span class="p">=</span> <span class="s2">"opsuser"</span> <span class="c1"># The user name within Kubernetes to map to the IAM role</span>
        <span class="nx">groups</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"system:masters"</span><span class="p">]</span> <span class="c1"># A list of groups within Kubernetes to which the role is mapped; Checkout K8s Role and Rolebindings</span>
        <span class="p">}</span>
    <span class="p">]</span>
    <span class="nx">map_accounts</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"123456789"</span><span class="p">,</span> <span class="s2">"9876543321"</span><span class="p">]</span> <span class="c1"># List of AWS account ids</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="managed-node-groups"> Managed Node Groups</h3><p>The example below demonstrates the minimum configuration required to deploy a managed node group. An example of the source code file relevant to this Guidance where those changes can be made can be found <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/blob/main/examples/eks-cluster-with-new-vpc/main.tf" target="_blank">here</a>.</p><div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># EKS MANAGED NODE GROUPS</span>
<span class="nx">managed_node_groups</span> <span class="err">=</span> <span class="p">{</span>
    <span class="nx">mg_4</span> <span class="p">=</span> <span class="p">{</span>
        <span class="nx">node_group_name</span> <span class="p">=</span> <span class="s2">"managed-ondemand"</span>
        <span class="nx">instance_types</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"m4.large"</span><span class="p">]</span>
        <span class="nx">min_size</span> <span class="p">=</span> <span class="mi">3</span>
        <span class="nx">max_size</span> <span class="p">=</span> <span class="mi">3</span>
        <span class="nx">desired_size</span> <span class="p">=</span> <span class="mi">3</span>
        <span class="nx">subnet_ids</span> <span class="p">=</span> <span class="p">[]</span> <span class="c1"># Mandatory Public or Private Subnet IDs</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>The example below demonstrates advanced configuration options for a managed node group with launch templates. An example of the source code file relevant to this Guidance where those changes can be made can be found <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/blob/main/examples/eks-cluster-with-new-vpc/main.tf" target="_blank">here</a>.</p><div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">managed_node_groups</span> <span class="err">=</span> <span class="p">{</span>
    <span class="nx">mg_m4</span> <span class="p">=</span> <span class="p">{</span>

        <span class="c1"># 1&gt; Node Group configuration</span>
        <span class="nx">node_group_name</span> <span class="p">=</span> <span class="s2">"managed-ondemand"</span>
        <span class="nx">create_launch_template</span> <span class="p">=</span> <span class="kc">true</span> <span class="c1"># false will use the default launch template</span>
        <span class="nx">launch_template_os</span> <span class="p">=</span> <span class="s2">"amazonlinux2eks"</span> <span class="c1"># amazonlinux2eks or windows or bottlerocket</span>
        <span class="nx">public_ip</span> <span class="p">=</span> <span class="kc">false</span> <span class="c1"># Use this to enable public IP for EC2 instances; only for public subnets used in launch templates;</span>
        <span class="nx">pre_userdata</span> <span class="p">=</span> <span class="o">&lt;&lt;-</span><span class="no">EOT</span><span class="sh">
        yum install -y amazon-ssm-agent
        systemctl enable amazon-ssm-agent &amp;&amp; systemctl start amazon-ssm-agent
</span><span class="no">        EOT

</span>        <span class="c1"># 2&gt; Node Group scaling configuration</span>
        <span class="nx">desired_size</span> <span class="p">=</span> <span class="mi">3</span>
        <span class="nx">max_size</span> <span class="p">=</span> <span class="mi">3</span>
        <span class="nx">min_size</span> <span class="p">=</span> <span class="mi">3</span>
        <span class="nx">max_unavailable</span> <span class="p">=</span> <span class="mi">1</span> <span class="c1"># or percentage = 20</span>

        <span class="c1"># 3&gt; Node Group compute configuration</span>
        <span class="nx">ami_type</span> <span class="p">=</span> <span class="s2">"AL2_x86_64"</span> <span class="c1"># Amazon Linux 2(AL2_x86_64), AL2_x86_64_GPU, AL2_ARM_64, BOTTLEROCKET_x86_64, BOTTLEROCKET_ARM_64</span>
        <span class="nx">capacity_type</span> <span class="p">=</span> <span class="s2">"ON_DEMAND"</span> <span class="c1"># ON_DEMAND or SPOT</span>
        <span class="nx">instance_types</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"m4.large"</span><span class="p">]</span> <span class="c1"># List of instances used only for SPOT type</span>
        <span class="nx">disk_size</span> <span class="p">=</span> <span class="mi">50</span>

        <span class="c1"># 4&gt; Node Group network configuration</span>
        <span class="nx">subnet_ids</span> <span class="p">=</span> <span class="p">[]</span> <span class="c1"># Mandatory - # Define private/public subnets list with comma separated ["subnet1","subnet2","subnet3"]</span>

        <span class="c1"># optionally, configure a taint on the compute node group:</span>
        <span class="nx">k8s_taints</span> <span class="p">=</span> <span class="p">[{</span><span class="nx">key</span><span class="p">=</span> <span class="s2">"purpose"</span><span class="p">,</span> <span class="nx">value</span><span class="p">=</span><span class="s2">"execution"</span><span class="p">,</span> <span class="s2">"effect"</span><span class="p">=</span><span class="s2">"NO_SCHEDULE"</span><span class="p">}]</span>

        <span class="nx">k8s_labels</span> <span class="p">=</span> <span class="p">{</span>
            <span class="nx">Environment</span> <span class="p">=</span> <span class="s2">"preprod"</span>
            <span class="nx">Zone</span> <span class="p">=</span> <span class="s2">"dev"</span>
            <span class="nx">WorkerType</span> <span class="p">=</span> <span class="s2">"ON_DEMAND"</span>
            <span class="p">}</span>
        <span class="nx">additional_tags</span> <span class="p">=</span> <span class="p">{</span>
            <span class="nx">ExtraTag</span> <span class="p">=</span> <span class="s2">"m4-on-demand"</span>
            <span class="nx">Name</span> <span class="p">=</span> <span class="s2">"m4-on-demand"</span>
            <span class="nx">subnet_type</span> <span class="p">=</span> <span class="s2">"private"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>For additional EKS Node Group configuration options, please see the following <a href="https://aws-ia.github.io/terraform-aws-eks-blueprints/node-groups/" target="_blank">documentation</a> on GitHub.</p><p>Check the following references for additional details:</p><ul><li><p><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/nvme-ebs-volumes.html" target="_blank">Amazon EBS and NVMe on Linux instances</a></p><li><p><a href="https://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/aws-nvme-drivers.html" target="_blank">AWS NVMe drivers for Windows instances</a></p><li><p><a href="https://aws.amazon.com/blogs/aws/ec2-instance-update-m5-instances-with-local-nvme-storage-m5d/" target="_blank">EC2 Instance Update – M5 Instances with Local NVMe Storage (M5d)</a></p></ul><h2 id="iam-policies-and-roles"> <a href="#iam-policies-and-roles" class="anchor-heading" aria-labelledby="iam-policies-and-roles"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> IAM Policies and Roles</h2><p>The IAM policy below illustrates the minimum set of permissions needed to run EKS Blueprints, mainly focused on the list of allowed IAM actions:</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
</span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
</span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"aps:CreateAlertManagerDefinition"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"aps:CreateWorkspace"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"aps:DeleteAlertManagerDefinition"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"aps:DeleteWorkspace"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"aps:DescribeAlertManagerDefinition"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"aps:DescribeWorkspace"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"aps:ListTagsForResource"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"autoscaling:CreateAutoScalingGroup"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"autoscaling:CreateOrUpdateTags"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"autoscaling:DeleteAutoScalingGroup"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"autoscaling:DeleteLifecycleHook"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"autoscaling:DeleteTags"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"autoscaling:DescribeAutoScalingGroups"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"autoscaling:DescribeLifecycleHooks"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"autoscaling:DescribeTags"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"autoscaling:PutLifecycleHook"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"autoscaling:SetInstanceProtection"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"autoscaling:UpdateAutoScalingGroup"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:AllocateAddress"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:AssociateRouteTable"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:AttachInternetGateway"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:AuthorizeSecurityGroupEgress"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:AuthorizeSecurityGroupIngress"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:CreateEgressOnlyInternetGateway"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:CreateInternetGateway"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:CreateLaunchTemplate"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:CreateNatGateway"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:CreateNetworkAclEntry"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:CreateRoute"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:CreateRouteTable"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:CreateSecurityGroup"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:CreateSubnet"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:CreateTags"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:CreateVpc"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DeleteEgressOnlyInternetGateway"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DeleteInternetGateway"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DeleteLaunchTemplate"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DeleteNatGateway"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DeleteNetworkAclEntry"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DeleteRoute"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DeleteRouteTable"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DeleteSecurityGroup"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DeleteSubnet"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DeleteTags"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DeleteVpc"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DescribeAccountAttributes"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DescribeAddresses"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DescribeAvailabilityZones"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DescribeEgressOnlyInternetGateways"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DescribeImages"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DescribeInternetGateways"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DescribeLaunchTemplateVersions"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DescribeLaunchTemplates"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DescribeNatGateways"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DescribeNetworkAcls"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DescribeNetworkInterfaces"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DescribeRouteTables"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DescribeSecurityGroups"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DescribeSecurityGroupRules"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DescribeSubnets"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DescribeTags"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DescribeVpcAttribute"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DescribeVpcClassicLink"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DescribeVpcClassicLinkDnsSupport"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DescribeVpcs"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DetachInternetGateway"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:DisassociateRouteTable"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:ModifySubnetAttribute"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:ModifyVpcAttribute"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:ReleaseAddress"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:RevokeSecurityGroupEgress"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ec2:RevokeSecurityGroupIngress"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"eks:CreateAddon"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"eks:CreateCluster"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"eks:CreateFargateProfile"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"eks:CreateNodegroup"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"eks:DeleteAddon"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"eks:DeleteCluster"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"eks:DeleteFargateProfile"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"eks:DeleteNodegroup"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"eks:DescribeAddon"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"eks:DescribeAddonVersions"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"eks:DescribeCluster"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"eks:DescribeFargateProfile"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"eks:DescribeNodegroup"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"eks:TagResource"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"elasticfilesystem:CreateFileSystem"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"elasticfilesystem:CreateMountTarget"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"elasticfilesystem:DeleteFileSystem"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"elasticfilesystem:DeleteMountTarget"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"elasticfilesystem:DescribeFileSystems"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"elasticfilesystem:DescribeLifecycleConfiguration"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"elasticfilesystem:DescribeMountTargetSecurityGroups"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"elasticfilesystem:DescribeMountTargets"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"emr-containers:CreateVirtualCluster"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"emr-containers:DeleteVirtualCluster"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"emr-containers:DescribeVirtualCluster"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"events:DeleteRule"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"events:DescribeRule"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"events:ListTagsForResource"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"events:ListTargetsByRule"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"events:PutRule"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"events:PutTargets"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"events:RemoveTargets"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:AddRoleToInstanceProfile"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:AttachRolePolicy"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:CreateInstanceProfile"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:CreateOpenIDConnectProvider"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:CreatePolicy"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:CreateRole"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:CreateServiceLinkedRole"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:DeleteInstanceProfile"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:DeleteOpenIDConnectProvider"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:DeletePolicy"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:DeleteRole"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:DetachRolePolicy"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:GetInstanceProfile"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:GetOpenIDConnectProvider"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:GetPolicy"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:GetPolicyVersion"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:GetRole"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:ListAttachedRolePolicies"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:ListInstanceProfilesForRole"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:ListPolicyVersions"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:ListRolePolicies"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:PassRole"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:RemoveRoleFromInstanceProfile"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:TagOpenIDConnectProvider"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:TagInstanceProfile"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:TagPolicy"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:TagRole"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"iam:UpdateAssumeRolePolicy"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"kms:CreateAlias"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"kms:CreateKey"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"kms:DeleteAlias"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"kms:DescribeKey"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"kms:EnableKeyRotation"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"kms:GetKeyPolicy"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"kms:GetKeyRotationStatus"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"kms:ListAliases"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"kms:ListResourceTags"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"kms:PutKeyPolicy"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"kms:ScheduleKeyDeletion"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"kms:TagResource"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"logs:CreateLogGroup"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"logs:DeleteLogGroup"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"logs:DescribeLogGroups"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"logs:ListTagsLogGroup"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"logs:PutRetentionPolicy"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:CreateBucket"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:DeleteBucket"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:DeleteBucketOwnershipControls"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:DeleteBucketPolicy"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:DeleteObject"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:GetAccelerateConfiguration"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:GetBucketAcl"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:GetBucketCORS"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:GetBucketLogging"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:GetBucketObjectLockConfiguration"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:GetBucketOwnershipControls"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:GetBucketPolicy"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:GetBucketPublicAccessBlock"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:GetBucketRequestPayment"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:GetBucketTagging"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:GetBucketVersioning"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:GetBucketWebsite"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:GetEncryptionConfiguration"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:GetLifecycleConfiguration"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:GetObject"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:GetObjectTagging"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:GetObjectVersion"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:GetReplicationConfiguration"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:ListAllMyBuckets"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:ListBucket"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:PutBucketAcl"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:PutBucketOwnershipControls"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:PutBucketPolicy"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:PutBucketPublicAccessBlock"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:PutBucketTagging"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:PutBucketVersioning"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:PutEncryptionConfiguration"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"s3:PutObject"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"secretsmanager:CreateSecret"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"secretsmanager:DeleteSecret"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"secretsmanager:DescribeSecret"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"secretsmanager:GetResourcePolicy"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"secretsmanager:GetSecretValue"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"secretsmanager:PutSecretValue"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"sqs:CreateQueue"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"sqs:DeleteQueue"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"sqs:GetQueueAttributes"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"sqs:ListQueueTags"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"sqs:SetQueueAttributes"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"sqs:TagQueue"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"sts:GetCallerIdentity"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="w">
    </span><span class="p">}</span><span class="w">
 </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p>The source code can be also found <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/blob/main/examples/eks-cluster-with-new-vpc/min-iam-policy.json" target="_blank">here</a>.</p><h2 id="teams-1"> <a href="#teams-1" class="anchor-heading" aria-labelledby="teams-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Teams</h2><h3 id="introduction-1"> Introduction</h3><p>EKS Blueprints provide support for onboarding and managing user teams and configuring their cluster access. They currently support two <code class="language-plaintext highlighter-rouge">Team</code> types: <code class="language-plaintext highlighter-rouge">application_teams</code> and <code class="language-plaintext highlighter-rouge">platform_teams;</code> <code class="language-plaintext highlighter-rouge">application_teams</code> represent teams managing workloads running in cluster namespaces and <code class="language-plaintext highlighter-rouge">platform_teams</code> represent platform administrators who have admin access (master’s group) to clusters.</p><p>You can reference the <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/tree/main/modules/aws-eks-teams" target="_blank">aws-eks-teams</a> module to create your own team implementations.</p><h3 id="application-team"> Application Team</h3><p>To create an <code class="language-plaintext highlighter-rouge">application_team</code> for your clusters, you will need to supply the following:</p><ul><li><p>A team name with the options to pass map of labels</p><li><p>Map of K8s resource quotas</p><li><p>Existing IAM entities (user/roles)</p><li><p>A directory where you may optionally place any policy definitions and generic manifests for the team.</p></ul><p>These manifests will be applied by EKS Blueprints and will be outside of the team control.</p><p class="note">When the manifests are applied, namespaces are not checked. Therefore, you are responsible for namespace settings specified in IaC <em>yaml</em> files.</p><p>Normally, resource <code class="language-plaintext highlighter-rouge">kubernetes_manifest</code> can only be used (<code class="language-plaintext highlighter-rouge">terraform plan/apply...</code>) <strong>after</strong> the cluster has been created and the cluster API can be accessed.</p><p>To overcome this limitation, you can add/enable <code class="language-plaintext highlighter-rouge">manifests_dir</code> after you applied and created the EKS cluster first.</p><p><strong>Application Team Example</strong></p><p>Below is a source code example for <code class="language-plaintext highlighter-rouge">application_team.</code> A source code example where those changes can be made for this Guidance can be found <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/tree/main/modules/aws-eks-teams" target="_blank">here</a>.</p><div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># EKS Application Teams</span>

<span class="nx">application_teams</span> <span class="err">=</span> <span class="p">{</span>
    <span class="c1"># First Team</span>
    <span class="nx">team</span><span class="err">-</span><span class="nx">blue</span> <span class="p">=</span> <span class="p">{</span>
        <span class="s2">"labels"</span> <span class="p">=</span> <span class="p">{</span>
            <span class="s2">"appName"</span> <span class="p">=</span> <span class="s2">"example1"</span><span class="p">,</span>
            <span class="s2">"projectName"</span> <span class="p">=</span> <span class="s2">"example1"</span><span class="p">,</span>
            <span class="s2">"environment"</span> <span class="p">=</span> <span class="s2">"example1"</span><span class="p">,</span>
            <span class="s2">"domain"</span> <span class="p">=</span> <span class="s2">"example1"</span><span class="p">,</span>
            <span class="s2">"uuid"</span> <span class="p">=</span> <span class="s2">"example1"</span><span class="p">,</span>
            <span class="p">}</span>
    <span class="s2">"quota"</span> <span class="p">=</span> <span class="p">{</span>
        <span class="s2">"requests.cpu"</span> <span class="p">=</span> <span class="s2">"1000m"</span><span class="p">,</span>
        <span class="s2">"requests.memory"</span> <span class="p">=</span> <span class="s2">"4Gi"</span><span class="p">,</span>
        <span class="s2">"limits.cpu"</span> <span class="p">=</span> <span class="s2">"2000m"</span><span class="p">,</span>
        <span class="s2">"limits.memory"</span> <span class="p">=</span> <span class="s2">"8Gi"</span><span class="p">,</span>
        <span class="s2">"pods"</span> <span class="p">=</span> <span class="s2">"10"</span><span class="p">,</span>
        <span class="s2">"secrets"</span> <span class="p">=</span> <span class="s2">"10"</span><span class="p">,</span>
        <span class="s2">"services"</span> <span class="p">=</span> <span class="s2">"10"</span>
        <span class="p">}</span>
    <span class="nx">manifests_dir</span> <span class="p">=</span> <span class="s2">"./manifests"</span>

    <span class="c1"># Below are examples of IAM users and roles</span>
    <span class="nx">users</span> <span class="p">=</span> <span class="p">[</span>
        <span class="s2">"arn:aws:iam::123456789012:user/blue-team-user"</span><span class="p">,</span>
        <span class="s2">"arn:aws:iam::123456789012:role/blue-team-sso-iam-role"</span>
        <span class="p">]</span>
    <span class="p">}</span>
    <span class="c1"># Second Team</span>
    <span class="nx">team</span><span class="err">-</span><span class="nx">red</span> <span class="p">=</span> <span class="p">{</span>
        <span class="s2">"labels"</span> <span class="p">=</span> <span class="p">{</span>
            <span class="s2">"appName"</span> <span class="p">=</span> <span class="s2">"example2"</span><span class="p">,</span>
            <span class="s2">"projectName"</span> <span class="p">=</span> <span class="s2">"example2"</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="s2">"quota"</span> <span class="p">=</span> <span class="p">{</span>
            <span class="s2">"requests.cpu"</span> <span class="p">=</span> <span class="s2">"2000m"</span><span class="p">,</span>
            <span class="s2">"requests.memory"</span> <span class="p">=</span> <span class="s2">"8Gi"</span><span class="p">,</span>
            <span class="s2">"limits.cpu"</span> <span class="p">=</span> <span class="s2">"4000m"</span><span class="p">,</span>
            <span class="s2">"limits.memory"</span> <span class="p">=</span> <span class="s2">"16Gi"</span><span class="p">,</span>
            <span class="s2">"pods"</span> <span class="p">=</span> <span class="s2">"20"</span><span class="p">,</span>
            <span class="s2">"secrets"</span> <span class="p">=</span> <span class="s2">"20"</span><span class="p">,</span>
            <span class="s2">"services"</span> <span class="p">=</span> <span class="s2">"20"</span>
            <span class="p">}</span>
        <span class="nx">manifests_dir</span> <span class="p">=</span> <span class="s2">"./manifests2"</span>
        <span class="nx">users</span> <span class="p">=</span> <span class="p">[</span>
            <span class="s2">"arn:aws:iam::123456789012:role/other-sso-iam-role"</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>EKS Blueprints will perform the following for every provided team option:</p><ul><li><p>Create a namespace</p><li><p>Register Kubernetes resource quotas</p><li><p>Register IAM users for cross-account access</p><li><p>Create a shared role for cluster access. Alternatively, an existing role can be supplied.</p><li><p>Register provided users/roles in the <code class="language-plaintext highlighter-rouge">aws-auth</code> configmap for <code class="language-plaintext highlighter-rouge">kubectl</code> and console access to the cluster and namespace.</p><li><p>(Optionally) read all additional manifests (e.g., network policies, OPA policies, others) stored in a provided directory, and apply them.</p></ul><h3 id="platform-team"> Platform Team</h3><p>To create a <code class="language-plaintext highlighter-rouge">Platform Team</code> for your cluster, use a <code class="language-plaintext highlighter-rouge">platform_teams</code> configuration. You will need to supply a team name and all users/roles.</p><p><strong>Platform Team Example</strong></p><p>Below is a source code example for <code class="language-plaintext highlighter-rouge">Platform Team.</code> An example of source code where those changes can be made for this Guidance can be found <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/tree/main/modules/aws-eks-teams" target="_blank">here</a>:</p><div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">platform_teams</span> <span class="err">=</span> <span class="p">{</span>
<span class="nx">admin</span><span class="err">-</span><span class="nx">team</span><span class="err">-</span><span class="nx">name</span><span class="err">-</span><span class="nx">example</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">users</span> <span class="p">=</span> <span class="p">[</span>
    <span class="s2">"arn:aws:iam::123456789012:user/admin-user"</span><span class="p">,</span>
    <span class="s2">"arn:aws:iam::123456789012:role/org-admin-role"</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">Platform Team</code> performs the following:</p><ul><li><p>Registers IAM users for admin level access to the EKS cluster (<code class="language-plaintext highlighter-rouge">kubectl</code> and console).</p><li><p>Registers an existing role (or creates a new role) for cluster access with trust relationship with the provided/created role.</p></ul><h3 id="cluster-access-kubectl"> Cluster Access (kubectl)</h3><p>The Terraform script execution output will contain the IAM roles for every application (<code class="language-plaintext highlighter-rouge">application_teams_iam_role_arn</code>) or platform team (<code class="language-plaintext highlighter-rouge">platform_teams_iam_role_arn</code>).</p><p>To update K8s cluster <em>kubeconfig</em> file contents, run the following command:</p><div class="language-shell note highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws eks update-kubeconfig <span class="nt">--name</span> <span class="k">${</span><span class="nv">eks_cluster_id</span><span class="k">}</span> <span class="nt">--region</span> <span class="k">${</span><span class="nv">AWS_REGION</span><span class="k">}</span> <span class="nt">--role-arn</span> <span class="k">${</span><span class="nv">TEAM_ROLE_ARN</span><span class="k">}</span>
</code></pre></div></div><p>Make sure to replace the <code class="language-plaintext highlighter-rouge">${eks_cluster_id}</code>,<code class="language-plaintext highlighter-rouge">${AWS_REGION}</code>and <code class="language-plaintext highlighter-rouge">${TEAM_ROLE_ARN}</code> with the actual values.</p><h2 id="kubernetes-add-ons-modules"> <a href="#kubernetes-add-ons-modules" class="anchor-heading" aria-labelledby="kubernetes-add-ons-modules"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Kubernetes Add-ons Modules</h2><p>The <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/tree/main/modules/kubernetes-addons" target="_blank">kubernetes-add-ons</a> modules within EKS Blueprints allows the user to configure the add-ons they would like deployed into their EKS clusters via simple <strong>true/false</strong> flags in the Terraform code.</p><p>The framework currently provides support for add-ons contained in the ‘kubernetes-addons’ source code repository <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/tree/main/modules/kubernetes-addons" target="_blank">folder</a>.</p><h3 id="add-on-management"> Add-on Management</h3><p>The framework provides two approaches to managing add-on configuration for EKS clusters. They are:</p><ol><li><p>Via Terraform by leveraging the <a href="https://registry.terraform.io/providers/hashicorp/helm/latest/docs" target="_blank">Terraform Helm provider</a>.</p><li><p>Via GitOps process with <a href="https://argo-cd.readthedocs.io/en/stable/" target="_blank">ArgoCD</a> (used in this Guidance)</p></ol><h3 id="terraform-helm-provider"> Terraform Helm Provider</h3><p>The default method for managing an add-on configuration is through Terraform. By default, each individual add-on module will perform the following:</p><ol><li><p>Create any AWS resources needed to support add-on functionality.</p><li><p>Deploy a <a href="https://helm.sh/" target="_blank">Helm chart</a> into the user’s EKS cluster by leveraging the Terraform Helm provider.</p></ol><p>In order to deploy an add-on with default configuration, the user enables it through Terraform property variables as shown below. An example of source code where those changes can be made for this Guidance can be found <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-data-apps-amazon-elastic-kubernetes-service-using-terraform/blob/main/analytics/terraform/spark-k8s-operator/addons.tf" target="_blank">here</a>.</p><div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="s2">"eks_blueprints_kubernetes_addons"</span> <span class="p">{</span>
    <span class="nx">source</span> <span class="p">=</span><span class="s2">"github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/modules/kubernetes-addons"</span>

    <span class="nx">cluster_id</span> <span class="p">=</span> <span class="err">&lt;</span><span class="nx">EKS</span><span class="err">-</span><span class="nx">CLUSTER</span><span class="err">-</span><span class="nx">ID</span><span class="err">&gt;</span>

    <span class="c1"># EKS Addons</span>

    <span class="nx">enable_amazon_eks_aws_ebs_csi_driver</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">enable_amazon_eks_coredns</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">enable_amazon_eks_kube_proxy</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">enable_amazon_eks_vpc_cni</span> <span class="p">=</span> <span class="kc">true</span>

    <span class="c1"># K8s Add-ons</span>

    <span class="nx">enable_argocd</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">enable_aws_for_fluentbit</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">enable_aws_load_balancer_controller</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">enable_cluster_autoscaler</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">enable_metrics_server</span> <span class="p">=</span> <span class="kc">true</span>
<span class="p">}</span>
</code></pre></div></div><p>To customize the behavior of the Helm charts that are ultimately deployed, the user can supply a custom Helm configuration. The following demonstrates how to use the configuration, including a dedicated <em>values.yaml</em> parameter customization file, to provide values for the Helm template. An example of a source code where these changes can be made for this Guidance can be found <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-data-apps-amazon-elastic-kubernetes-service-using-terraform/blob/main/analytics/terraform/spark-k8s-operator/addons.tf" target="_blank">here</a>.</p><div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">enable_metrics_server</span> <span class="err">=</span> <span class="kc">true</span>
<span class="nx">metrics_server_helm_config</span> <span class="err">=</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="p">=</span> <span class="s2">"metrics-server"</span>
    <span class="nx">repository</span> <span class="p">=</span> <span class="s2">"https://kubernetes-sigs.github.io/metrics-server/"</span>
    <span class="nx">chart</span> <span class="p">=</span> <span class="s2">"metrics-server"</span>
    <span class="nx">version</span> <span class="p">=</span> <span class="s2">"3.8.1"</span>
    <span class="nx">namespace</span> <span class="p">=</span> <span class="s2">"kube-system"</span>
    <span class="nx">timeout</span> <span class="p">=</span> <span class="s2">"1200"</span>

    <span class="c1"># (Optional) Example to pass values.yaml from your local repo</span>
    <span class="nx">values</span> <span class="p">=</span> <span class="p">[</span><span class="nx">templatefile</span><span class="p">(</span><span class="s2">"</span><span class="k">${</span><span class="nx">path</span><span class="p">.</span><span class="k">module}</span><span class="s2">/values.yaml"</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">operating_system</span> <span class="p">=</span> <span class="s2">"linux"</span>
    <span class="p">})]</span>
<span class="p">}</span>
</code></pre></div></div><p>Each add-on module is configured to fetch Helm Charts from public Helm repositories and Docker images from Docker Hub/Public Amazon Elastic Container Registry (Amazon ECR) repositories. This requires an outbound Internet connection from EKS Clusters.</p><h3 id="core-eks-add-ons"> Core EKS Add-ons</h3><p><a href="https://docs.aws.amazon.com/eks/latest/userguide/eks-add-ons.html" target="_blank">Amazon EKS add-ons</a> provide installation and management of a curated set of features for EKS clusters. All EKS add-ons include the latest security patches, bug fixes, and are validated to work with EKS. Amazon EKS add-ons allow you to consistently ensure that your EKS clusters are secure and stable and reduce the amount of work that you need to do in order to install, configure, and update add-ons.</p><p>EKS currently provides support for the following managed add-ons.</p><div class="table-wrapper"><table><thead><tr><th><strong>Name</strong><th><strong>Description</strong><tbody><tr><td><a href="https://docs.aws.amazon.com/eks/latest/userguide/managing-vpc-cni.html" target="_blank">Amazon VPC CNI</a><td>Native VPC networking for Kubernetes pods.<tr><td><a href="https://docs.aws.amazon.com/eks/latest/userguide/managing-coredns.html" target="_blank">CoreDNS</a><td>A flexible, extensible DNS server that can serve as the Kubernetes cluster DNS.<tr><td><a href="https://docs.aws.amazon.com/eks/latest/userguide/managing-kube-proxy.html" target="_blank">kube-proxy</a><td>Enables network communication to your pods.<tr><td><a href="https://docs.aws.amazon.com/eks/latest/userguide/managing-ebs-csi.html" target="_blank">Amazon EBS CSI</a><td>Manage the Amazon EBS CSI driver as an Amazon EKS add-on.</table></div><p>EKS managed add-ons can be enabled and configured as shown in the following source code:</p><div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># EKS Addons</span>
<span class="nx">enable_amazon_eks_vpc_cni</span> <span class="err">=</span> <span class="kc">true</span> <span class="c1"># enable VPC CNI, default is false</span>
<span class="c1">#Optional</span>
<span class="nx">amazon_eks_vpc_cni_config</span> <span class="err">=</span> <span class="p">{</span>
    <span class="nx">addon_name</span> <span class="p">=</span> <span class="s2">"vpc-cni"</span>
    <span class="nx">addon_version</span> <span class="p">=</span> <span class="s2">"v1.10.1-eksbuild.1"</span>
    <span class="nx">service_account</span> <span class="p">=</span> <span class="s2">"aws-node"</span>
    <span class="nx">resolve_conflicts</span> <span class="p">=</span> <span class="s2">"OVERWRITE"</span>
    <span class="nx">namespace</span> <span class="p">=</span> <span class="s2">"kube-system"</span>
    <span class="nx">additional_iam_policies</span> <span class="p">=</span> <span class="p">[]</span>
    <span class="nx">service_account_role_arn</span> <span class="p">=</span> <span class="s2">""</span>
    <span class="nx">tags</span> <span class="p">=</span> <span class="p">{}</span>
 <span class="p">}</span>
</code></pre></div></div><div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">enable_amazon_eks_coredns</span> <span class="err">=</span> <span class="kc">true</span> <span class="c1"># enable EKS CoreDNS, default is false</span>
<span class="c1">#Optional</span>
<span class="nx">amazon_eks_coredns_config</span> <span class="err">=</span> <span class="p">{</span>
    <span class="nx">addon_name</span> <span class="p">=</span> <span class="s2">"coredns"</span>
    <span class="nx">addon_version</span> <span class="p">=</span> <span class="s2">"v1.8.4-eksbuild.1"</span>
    <span class="nx">service_account</span> <span class="p">=</span> <span class="s2">"coredns"</span>
    <span class="nx">resolve_conflicts</span> <span class="p">=</span> <span class="s2">"OVERWRITE"</span>
    <span class="nx">namespace</span> <span class="p">=</span> <span class="s2">"kube-system"</span>
    <span class="nx">service_account_role_arn</span> <span class="p">=</span> <span class="s2">""</span>
    <span class="nx">additional_iam_policies</span> <span class="p">=</span> <span class="p">[]</span>
    <span class="nx">tags</span> <span class="p">=</span> <span class="p">{}</span>
 <span class="p">}</span>

<span class="nx">enable_amazon_eks_kube_proxy</span> <span class="err">=</span> <span class="kc">true</span> <span class="c1"># enable EKS Kube_proxy, default is false</span>
<span class="c1">#Optional</span>
<span class="nx">amazon_eks_kube_proxy_config</span> <span class="err">=</span> <span class="p">{</span>
    <span class="nx">addon_name</span> <span class="p">=</span> <span class="s2">"kube-proxy"</span>
    <span class="nx">addon_version</span> <span class="p">=</span> <span class="s2">"v1.21.2-eksbuild.2"</span>
    <span class="nx">service_account</span> <span class="p">=</span> <span class="s2">"kube-proxy"</span>
    <span class="nx">resolve_conflicts</span> <span class="p">=</span> <span class="s2">"OVERWRITE"</span>
    <span class="nx">namespace</span> <span class="p">=</span> <span class="s2">"kube-system"</span>
    <span class="nx">additional_iam_policies</span> <span class="p">=</span> <span class="p">[]</span>
    <span class="nx">service_account_role_arn</span> <span class="p">=</span> <span class="s2">""</span>
    <span class="nx">tags</span> <span class="p">=</span> <span class="p">{}</span>
 <span class="p">}</span>

<span class="nx">enable_amazon_eks_aws_ebs_csi_driver</span> <span class="err">=</span> <span class="kc">true</span> <span class="c1"># enable EBS CSI driver, default is false</span>
<span class="c1">#Optional</span>
<span class="nx">amazon_eks_aws_ebs_csi_driver_config</span> <span class="err">=</span> <span class="p">{</span>
    <span class="nx">addon_name</span> <span class="p">=</span> <span class="s2">"aws-ebs-csi-driver"</span>
    <span class="nx">addon_version</span> <span class="p">=</span> <span class="s2">"v1.4.0-eksbuild.preview"</span>
    <span class="nx">service_account</span> <span class="p">=</span> <span class="s2">"ebs-csi-controller-sa"</span>
    <span class="nx">resolve_conflicts</span> <span class="p">=</span> <span class="s2">"OVERWRITE"</span>
    <span class="nx">namespace</span> <span class="p">=</span> <span class="s2">"kube-system"</span>
    <span class="nx">additional_iam_policies</span> <span class="p">=</span> <span class="p">[]</span>
    <span class="nx">service_account_role_arn</span> <span class="p">=</span> <span class="s2">""</span>
    <span class="nx">tags</span> <span class="p">=</span> <span class="p">{}</span>
 <span class="p">}</span>
</code></pre></div></div><p>An example of the source code where similar changes can be made for this Guidance can be found <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/blob/main/examples/complete-kubernetes-addons/main.tf" target="_blank">here</a>.</p><h2 id="updating-managed-add-ons"> <a href="#updating-managed-add-ons" class="anchor-heading" aria-labelledby="updating-managed-add-ons"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Updating Managed Add-ons</h2><p>EKS will not modify any of your Kubernetes add-ons when you update a cluster to a newer Kubernetes version. As a result, it is important to upgrade EKS add-ons each time you upgrade your EKS clusters. Additional information on updating an EKS cluster can be found in the <a href="https://docs.aws.amazon.com/eks/latest/userguide/update-cluster.html" target="_blank">EKS documentation</a>.</p><h3 id="gitops-with-argocd"> GitOps with ArgoCD</h3><p>To indicate that you would like to manage EKS add-ons through an Argo CD GitOps tool, you should do the following:</p><ol><li><p>Enable the Argo CD add-on by setting the <code class="language-plaintext highlighter-rouge">enable_argocd</code> flag to <code class="language-plaintext highlighter-rouge">true</code> in the Terraform code.</p><li><p>Specify that ArgoCD should be responsible for deploying add-ons by setting the <code class="language-plaintext highlighter-rouge">argocd_manage_add_ons</code> flag to <code class="language-plaintext highlighter-rouge">true.</code> This will prevent the individual Terraform add-on modules from deploying through Helm charts.</p><li><p>Pass Application configuration for the add-ons repository through the <code class="language-plaintext highlighter-rouge">argocd_applications</code> property.</p></ol><p>Note that the <code class="language-plaintext highlighter-rouge">add_on_application</code> flag in an <code class="language-plaintext highlighter-rouge">Application</code> configuration must be set to <code class="language-plaintext highlighter-rouge">true.</code></p><div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">enable_argocd</span> <span class="err">=</span> <span class="kc">true</span>
<span class="nx">argocd_manage_add_ons</span> <span class="err">=</span> <span class="kc">true</span>
<span class="nx">argocd_applications</span> <span class="err">=</span> <span class="p">{</span>
    <span class="nx">infra</span> <span class="p">=</span> <span class="p">{</span>
        <span class="nx">namespace</span> <span class="p">=</span> <span class="s2">"argocd"</span>
        <span class="nx">path</span> <span class="p">=</span> <span class="s2">"&lt;path&gt;"</span>
        <span class="nx">repo_url</span> <span class="p">=</span> <span class="s2">"&lt;repo_url&gt;"</span>
        <span class="nx">values</span> <span class="p">=</span> <span class="p">{}</span>
        <span class="nx">add_on_application</span> <span class="p">=</span> <span class="kc">true</span> <span class="c1"># Indicates the root add-on application.</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>An example of source code where similar changes can be made can be found <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/blob/main/examples/gitops/argocd/main.tf" target="_blank">here</a>.</p><p><strong>GitOps Bridge</strong></p><p>When managing add-ons through Argo CD, certain AWS resources may still need to be created through Terraform in order to support the add-on functionality (for example: IAM Roles and Services Accounts). Certain resource values will also need to be passed from Terraform to Argo CD through the Argo CD Application resource’s values map. We refer to this concept as GitOps Bridge.</p><p>To ensure that the AWS resources needed for add-on functionality are created, you need to indicate a Terraform configuration where add-ons will be managed through Argo CD. To do so, enable selected add-ons through their boolean properties, as shown below:</p><div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">enable_metrics_server</span> <span class="err">=</span> <span class="kc">true</span> <span class="c1"># Deploys Metrics Server Addon</span>
<span class="nx">enable_cluster_autoscaler</span> <span class="err">=</span> <span class="kc">true</span> <span class="c1"># Deploys Cluster Autoscaler Addon</span>
<span class="nx">enable_prometheus</span> <span class="err">=</span> <span class="kc">true</span> <span class="c1"># Deploys Prometheus Addon</span>
</code></pre></div></div><p>An example of source code for the above settings where these changes can be made for this Guidance can be found <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/blob/main/examples/gitops/argocd/main.tf" target="_blank">here</a>.</p><p>This will indicate to each add-on module that it should create the necessary AWS resources and pass the relevant values to the <strong>Argo CD Application resource</strong> through the Application’s values map.</p><h3 id="argo-cd-add-on"> Argo CD Add-on</h3><p><a href="https://argo-cd.readthedocs.io/en/stable/" target="_blank">Argo CD</a> is a declarative, GitOps continuous delivery tool for Kubernetes Application definitions, configurations, and environments should be declarative and version controlled and stored in a Git compatible repository. Application deployment and lifecycle management should be automated, auditable, and easy to understand.</p><p><strong>Usage</strong></p><p>Argo CD can be deployed by enabling the add-on through a flag: <code class="language-plaintext highlighter-rouge">enable_argocd = true</code></p><p><strong>Admin Password</strong></p><p>Argo CD has a built-in admin user that has full access to the Argo CD server. By default, Argo CD will create a password for the admin user.</p><p>See the <a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/user-management/" target="_blank">Argo CD documentation</a> for additional details on managing users.</p><p><strong>Customizing Argo CD deployment Helm Chart</strong></p><p>You can customize the Helm chart that deploys Argo CD using the configuration below. An example of source code where similar changes can be made for this Guidance can be found <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/blob/main/examples/gitops/argocd/main.tf" target="_blank">here</a>.</p><div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">argocd_helm_config</span> <span class="err">=</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="p">=</span> <span class="s2">"argo-cd"</span>
    <span class="nx">chart</span> <span class="p">=</span> <span class="s2">"argo-cd"</span>
    <span class="nx">repository</span> <span class="p">=</span> <span class="s2">"https://argoproj.github.io/argo-helm"</span>
    <span class="nx">version</span> <span class="p">=</span> <span class="s2">"&lt;chart_version&gt;"</span>
    <span class="nx">namespace</span> <span class="p">=</span> <span class="s2">"argocd"</span>
    <span class="nx">timeout</span> <span class="p">=</span> <span class="s2">"1200"</span>
    <span class="nx">create_namespace</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">values</span> <span class="p">=</span> <span class="p">[</span><span class="nx">templatefile</span><span class="p">(</span><span class="s2">"</span><span class="k">${</span><span class="nx">path</span><span class="p">.</span><span class="k">module}</span><span class="s2">/argocd-values.yaml"</span><span class="p">,</span> <span class="p">{})]</span>
<span class="p">}</span>
</code></pre></div></div><p><strong>Bootstrapping</strong></p><p>The framework provides an approach to bootstrapping workloads and/or additional add-ons by leveraging the Argo CD <a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/cluster-bootstrapping/" target="_blank">App of Apps</a> pattern.</p><p>The code example below demonstrates how you can supply information for a repository in order to bootstrap multiple workloads in a new EKS cluster. The example leverages a <a href="https://github.com/aws-samples/eks-blueprints-workloads.git" target="_blank">sample App of Apps repository</a>. An example of source code where these changes can be made for this Guidance can be found <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/blob/main/examples/gitops/argocd/main.tf" target="_blank">here</a>.</p><div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">argocd_applications</span> <span class="err">=</span> <span class="p">{</span>
    <span class="nx">addons</span> <span class="p">=</span> <span class="p">{</span>
        <span class="nx">path</span> <span class="p">=</span> <span class="s2">"chart"</span>
        <span class="nx">repo_url</span> <span class="p">=</span> <span class="s2">"https://github.com/aws-samples/eks-blueprints-add-ons.git"</span>
        <span class="nx">add_on_application</span> <span class="p">=</span> <span class="kc">true</span> <span class="c1"># Indicates the root add-on application.</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p><strong>Managing EKS Add-ons</strong></p><p>A common operational pattern for EKS customers is to leverage Infrastructure as Code (IaC) to provision EKS clusters (in addition to other AWS resources), and Argo CD to manage cluster add-ons. This can present a challenge when add-ons managed by Argo CD depend on AWS resource values that are created through a Terraform execution, such as IAM Amazon Resource Names (ARN) for an add-on that leverages IAM roles for service accounts (IRSA). The framework provides an approach to bridge the gap between Terraform and Argo CD by leveraging the Argo CD <a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/cluster-bootstrapping/" target="_blank">App of Apps</a> pattern.</p><p>To indicate that Argo CD should manage cluster add-ons (applying add-on Helm charts to a cluster), you can set the <code class="language-plaintext highlighter-rouge">argocd_manage_add_ons</code> property to <code class="language-plaintext highlighter-rouge">true.</code> When this flag is set, the framework will still provision all AWS resources necessary to support add-on functionality, but it will not apply Helm charts directly through the Terraform Helm provider.</p><p>Next, identify which Argo CD Application will serve as the add-on configuration repository by setting the <code class="language-plaintext highlighter-rouge">add_on_application</code> flag to <code class="language-plaintext highlighter-rouge">true.</code> When this flag is set, the framework will aggregate AWS resource values that are needed for each add-on into an object. It will then pass that object to Argo CD through the values map of the Application resource. <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/blob/main/modules/kubernetes-addons/locals.tf" target="_blank">See here</a> for all the values objects that are passed to the Argo CD add-ons Application.</p><p>Sample configuration is below:</p><div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">enable_argocd</span> <span class="err">=</span> <span class="kc">true</span>
<span class="nx">argocd_manage_add_ons</span> <span class="err">=</span> <span class="kc">true</span>
<span class="nx">argocd_applications</span> <span class="err">=</span> <span class="p">{</span>
    <span class="nx">addons</span> <span class="p">=</span> <span class="p">{</span>
        <span class="nx">path</span> <span class="p">=</span> <span class="s2">"chart"</span>
        <span class="nx">repo_url</span> <span class="p">=</span> <span class="s2">"https://github.com/aws-samples/eks-blueprints-add-ons.git"</span> <span class="c1"># public repository</span>
        <span class="nx">add_on_application</span> <span class="p">=</span> <span class="kc">true</span> <span class="c1"># Indicates the root add-on application.</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div><p>The source code for the above examples where these changes can be made for this Guidance can be found <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/blob/main/examples/gitops/argocd/main.tf" target="_blank">here</a>.</p><p><strong>Private Repositories</strong></p><p>In order to leverage Argo CD with private Git repositories, please see related <a href="https://aws-ia.github.io/terraform-aws-eks-blueprints/v4.20.0/add-ons/argocd/" target="_blank">documentation</a> on GitHub.</p><p><strong>Complete Example</strong></p><p>A complete example that demonstrates the configuration of Argo CD for the management of cluster add-ons can be found in this <a href="https://aws-ia.github.io/terraform-aws-eks-blueprints/v4.20.0/add-ons/argocd/" target="_blank">documentation</a>.</p><h3 id="apache-spark-kubernetes-operator-add-on"> Apache Spark Kubernetes Operator Add-on</h3><p>The <code class="language-plaintext highlighter-rouge">spark-on-k8s-operator</code> allows Apache Spark applications to be defined in a declarative manner and supports one-time Apache Spark applications with <a href="https://github.com/GoogleCloudPlatform/spark-on-k8s-operator/blob/master/docs/api-docs.md#sparkoperator.k8s.io/v1beta2.SparkApplication" target="_blank">SparkApplication</a> and cron-scheduled applications with <a href="https://github.com/GoogleCloudPlatform/spark-on-k8s-operator/blob/master/docs/api-docs.md#sparkoperator.k8s.io/v1beta2.ScheduledSparkApplication" target="_blank">ScheduledSparkApplication</a>.</p><p>Apache Spark aims to make specifying and running Apache Spark applications as easy and idiomatic as running other workloads on Kubernetes. It uses Kubernetes custom resources for specifying, running, and surfacing the status of Apache Spark applications. For a complete reference of the custom resource definitions, please refer to the <a href="https://spark.apache.org/docs/latest/running-on-kubernetes.html#kubernetes-features" target="_blank">API Definition</a>. For details on its design, please refer to the <a href="https://spark.apache.org/docs/latest/running-on-kubernetes.html" target="_blank">design documentation</a>. It requires Apache Spark 2.3 and above that supports Kubernetes as a native scheduler backend.</p><p><strong>Usage</strong></p><p><a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-data-apps-amazon-elastic-kubernetes-service-using-terraform/tree/main/analytics/terraform/spark-k8s-operator" target="_blank">Apache Spark K8S Operator</a> can be deployed by enabling the add-on with the following settings:</p><p>Basic example:</p><p><code class="language-plaintext highlighter-rouge">enable_spark_k8s_operator = true</code></p><p>Advanced example:</p><div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">enable_spark_k8s_operator</span> <span class="err">=</span> <span class="kc">true</span>
<span class="c1"># Optional Map value</span>
<span class="c1"># NOTE: This block requires passing the helm values.yaml</span>
<span class="nx">spark_k8s_operator_helm_config</span> <span class="err">=</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="p">=</span> <span class="s2">"spark-operator"</span>
    <span class="nx">chart</span> <span class="p">=</span> <span class="s2">"spark-operator"</span>
    <span class="nx">repository</span> <span class="p">=</span> <span class="s2">"https://googlecloudplatform.github.io/spark-on-k8s-operator"</span>
    <span class="nx">version</span> <span class="p">=</span> <span class="s2">"1.1.19"</span>
    <span class="nx">namespace</span> <span class="p">=</span> <span class="s2">"spark-k8s-operator"</span>
    <span class="nx">timeout</span> <span class="p">=</span> <span class="s2">"1200"</span>
    <span class="nx">create_namespace</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">values</span> <span class="p">=</span> <span class="p">[</span><span class="nx">templatefile</span><span class="p">(</span><span class="s2">"</span><span class="k">${</span><span class="nx">path</span><span class="p">.</span><span class="k">module}</span><span class="s2">/values.yaml"</span><span class="p">,</span> <span class="p">{})]</span>
<span class="p">}</span>
</code></pre></div></div><p>A Spark Operator example source code can be found <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-data-apps-amazon-elastic-kubernetes-service-using-terraform/blob/main/analytics/terraform/spark-k8s-operator/addons.tf" target="_blank">here</a>.</p><h3 id="apache-spark-history-server-add-on"> Apache Spark History Server Add-on</h3><p>Apache Spark Web UI can be enabled by the Apache Spark History Server Add-on. This add-on deploys Apache Spark History Server and fetches the Apache Spark Event logs stored in Amazon Simple Storage Service (Amazon S3). The Apache Spark Web UI can be exposed through Ingress and Load Balancer with <code class="language-plaintext highlighter-rouge">values yaml.</code> Alternatively, you can port-forward on <code class="language-plaintext highlighter-rouge">spark-history-server service,</code> for example:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl port-forward services/spark-history-server 18085:80 -n spark-history-server
</code></pre></div></div><p><strong>Usage</strong></p><p><a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/tree/main/modules/kubernetes-addons/spark-history-server" target="_blank">Apache Spark History Server</a> can be deployed by enabling the add-on through the following example source codes:</p><p><strong>Basic Example</strong></p><div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">enable_spark_history_server</span> <span class="err">=</span> <span class="kc">true</span>
<span class="nx">spark_history_server_s3a_path</span> <span class="err">=</span> <span class="s2">"s3a://&lt;ENTER_S3_BUCKET_NAME&gt;/&lt;PREFIX_FOR_SPARK_EVENT_LOGS&gt;/"</span>
</code></pre></div></div><p><strong>Advanced Example</strong></p><div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">enable_spark_history_server</span> <span class="err">=</span> <span class="kc">true</span>

<span class="c1"># IAM policy used by IRSA role. It's recommended to create a dedicated IAM policy to access your s3 bucket</span>
<span class="nx">spark_history_server_irsa_policies</span> <span class="err">=</span> <span class="p">[</span><span class="s2">"&lt;IRSA_POLICY_ARN&gt;"</span><span class="p">]</span>

<span class="c1"># NOTE: This block requires passing the helm values.yaml</span>
<span class="c1"># spark_history_server_s3a_path won't be used when you pass custom `values.yaml`. s3a path is passed via `sparkHistoryOpts` in `values.yaml`</span>

<span class="nx">spark_history_server_helm_config</span> <span class="err">=</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="p">=</span> <span class="s2">"spark-history-server"</span>
    <span class="nx">chart</span> <span class="p">=</span> <span class="s2">"spark-history-server"</span>
    <span class="nx">repository</span> <span class="p">=</span> <span class="s2">"https://hyper-mesh.github.io/spark-history-server"</span>
    <span class="nx">version</span> <span class="p">=</span> <span class="s2">"1.0.0"</span>
    <span class="nx">namespace</span> <span class="p">=</span> <span class="s2">"spark-history-server"</span>
    <span class="nx">timeout</span> <span class="p">=</span> <span class="s2">"300"</span>
    <span class="nx">values</span> <span class="p">=</span> <span class="p">[</span>
        <span class="o">&lt;&lt;-</span><span class="no">EOT</span><span class="sh"></span>
        serviceAccount:
        create: <span class="s2">false</span>

        <span class="c1"># Enter S3 bucket with Spark Event logs location.</span>
        <span class="c1"># Ensure IRSA roles has permissions to read the files for the given S3 bucket</span>
        sparkHistoryOpts:
        <span class="s2">"-Dspark.history.fs.logDirectory=s3a://&lt;ENTER_S3_BUCKET_NAME&gt;/&lt;PREFIX_FOR_SPARK_EVENT_LOGS&gt;/"</span>

        <span class="c1"># Update spark conf according to your needs</span>
        sparkConf: |-
        <span class="s2">
        spark.hadoop.fs.s3a.aws.credentials.provider=com.amazonaws.auth.WebIdentityTokenCredentialsProvider
        spark.history.fs.eventLog.rolling.maxFilesToRetain=5
        spark.hadoop.fs.s3a.impl=org.apache.hadoop.fs.s3a.S3AFileSystem
        spark.eventLog.enabled=true
        spark.history.ui.port=18080
        </span>

        resources:
            limits:
                cpu: <span class="s2">200m</span>
                memory: <span class="s2">2G</span>
            requests:
                cpu: <span class="s2">100m</span>
                memory: <span class="s2">1G</span>
        <span class="no">EOT</span>
    <span class="p">]</span>
<span class="p">}</span>

</code></pre></div></div><p>An example of the source code using the configuration settings above for Apache Spark History server can be found <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-data-apps-amazon-elastic-kubernetes-service-using-terraform/blob/main/analytics/terraform/spark-k8s-operator/addons.tf" target="_blank">here</a>.</p><h2 id="running-new-vpc-eks-terraform-blueprint"> <a href="#running-new-vpc-eks-terraform-blueprint" class="anchor-heading" aria-labelledby="running-new-vpc-eks-terraform-blueprint"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Running new VPC EKS Terraform Blueprint</h2><h3 id="prerequisites"> Prerequisites</h3><p>Ensure that you have installed the following tools in your Mac or Windows Laptop before you start working with this module; run <strong>Terraform Plan</strong> and select <strong>Apply</strong>:</p><ol><li><p><a href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html" target="_blank">AWS CLI</a></p><li><p><a href="https://Kubernetes.io/docs/tasks/tools/" target="_blank">Kubectl</a></p><li><p><a href="https://learn.hashicorp.com/tutorials/terraform/install-cli" target="_blank">Terraform</a></p></ol><h3 id="minimum-iam-policy"> Minimum IAM Policy</h3><p class="note">The policy resource is set as * to allow all resources. This is not a recommended practice.</p><p>Minimum IAM policy is documented <a href="#iam-policies-and-roles">above</a> and can be found <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/blob/main/examples/eks-cluster-with-new-vpc/min-iam-policy.json" target="_blank">here</a> – it is automatically bootstrapped to EKS clusters provisioned by blueprints.</p><h3 id="deployment"> Deployment</h3><p>To provision EKS Cluster with new VPC managed components and application workloads, you should follow these steps:</p><ol><li>Clone the repo using the command below:</ol><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform.git
</code></pre></div></div><ol style="counter-reset:none"><li>Initialize Terraform:</ol><div style="counter-reset:none" class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>examples/eks-cluster-with-new-vpc/
terraform init
</code></pre></div></div><ol><li>Verify resources to be created by this blueprint:</ol><div style="counter-reset:none" class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform plan
</code></pre></div></div><ol><li>Apply staged resources to AWS environment:</ol><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform apply
</code></pre></div></div><p>(Enter <em>yes</em> at the command prompt to apply or use <code class="language-plaintext highlighter-rouge">terraform apply -auto-approve</code> to bypass that question)</p><h3 id="validation"> Validation</h3><p>The following command will update the <em>kubeconfig</em> on the user’s machine and allow it to interact with the EKS Cluster using the <code class="language-plaintext highlighter-rouge">kubectl</code> client to validate the deployment.</p><ol><li>Run <em>update-kubeconfig</em> command which will update the local K8s configuration file by adding a context corresponding to newly created cluster:</ol><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws eks <span class="nt">--region</span> &lt;REGION&gt; update-kubeconfig <span class="nt">--name</span> &lt;CLUSTER_NAME&gt;
</code></pre></div></div><ol style="counter-reset:none"><li>List all the worked nodes by running the command below:</ol><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get nodes
</code></pre></div></div><figure><img class="docimage" src="images/eks-provision-terraform/terraform-Figure7.png" alt="" /></figure><ol style="counter-reset:none"><li>List all the pods running in kube-system namespace:</ol><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods <span class="nt">-n</span> kube-system
</code></pre></div></div><figure><img class="docimage" src="images/eks-provision-terraform/terraform-Figure8.png" alt="" /></figure><p><strong>Cleanup</strong></p><p>To clean up your environment, destroy the Terraform modules in reverse order of their deployment.</p><p>Destroy the Kubernetes Add-ons, EKS cluster with Node groups and VPC:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform destroy <span class="nt">-target</span><span class="o">=</span><span class="s2">"module.eks_blueprints_kubernetes_addons"</span> <span class="nt">-auto-approve</span>
terraform destroy <span class="nt">-target</span><span class="o">=</span><span class="s2">"module.eks_blueprints"</span> <span class="nt">-auto-approve</span>
terraform destroy <span class="nt">-target</span><span class="o">=</span><span class="s2">"module.vpc"</span> <span class="nt">-auto-approve</span>
</code></pre></div></div><p>Finally, destroy any additional resources that are not in the above modules:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform destroy <span class="nt">-auto-approve</span>
</code></pre></div></div><h2 id="running-argo-cd-eks-terraform-blueprint"> <a href="#running-argo-cd-eks-terraform-blueprint" class="anchor-heading" aria-labelledby="running-argo-cd-eks-terraform-blueprint"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Running Argo CD EKS Terraform Blueprint</h2><h3 id="prerequisites-1"> Prerequisites</h3><p>Ensure that the following tools are installed locally:</p><ol><li><p><a href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html" target="_blank">aws cli</a></p><li><p><a href="https://kubernetes.io/docs/tasks/tools/" target="_blank">kubectl</a></p><li><p><a href="https://learn.hashicorp.com/tutorials/terraform/install-cli" target="_blank">terraform</a></p></ol><h3 id="minimum-iam-policy-1"> Minimum IAM Policy</h3><p class="note">The policy resource is set as * to allow all resources, this is not a recommended practice.</p><p>Minimum IAM policy is documented <a href="#iam-policies-and-roles">above</a> and can be found in the project repository <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/blob/main/examples/gitops/argocd/min-iam-policy.json" target="_blank">here</a> – it is automatically bootstrapped to EKS clusters provisioned by blueprints</p><h3 id="deployment-1"> Deployment</h3><p>To provision EKS Cluster with Argo CD managed components and application workloads, you should follow these steps:</p><ol><li>Clone EKS blueprints repository locally:</ol><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform.git
</code></pre></div></div><p>If any customization of parameters is needed, it can be performed by adjusting/adding parameter values in the <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/blob/main/examples/gitops/argocd/main.tf" target="_blank">main.tf</a> source code file according to the documentation above. This includes basic AWS configuration: cluster name, deployment Region, VPC Classless Inter-Domain Routing (CIDR), and Availability Zones (AZs). Additionally, EKS Kubernetes parameters: K8s API version, managed node group instance types and ranges, tags, and add-ons can also be customized.</p><p>Below is an example of such parameters with minor modifications highlighted in # comments:</p><div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">locals</span> <span class="p">{</span>
        <span class="c1"># Optional customization: add unique postfix to cluster_name to avoid duplication or 'global'</span>
        <span class="c1"># role names derived from a cluster name</span>

        <span class="nx">name1</span> <span class="p">=</span> <span class="nx">basename</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">cwd</span><span class="p">)</span>
        <span class="nx">name</span> <span class="p">=</span> <span class="s2">"</span><span class="k">${</span><span class="kd">local</span><span class="p">.</span><span class="nx">name1</span><span class="k">}</span><span class="s2">-test1"</span>
        <span class="c1"># Customization: us-west-2 region has sufficient resources</span>
        <span class="nx">region</span> <span class="p">=</span> <span class="s2">"us-west-2"</span>

        <span class="c1"># Customization: VPC parameters</span>
        <span class="nx">vpc_cidr</span> <span class="p">=</span> <span class="s2">"10.0.0.0/16"</span>
        <span class="nx">azs</span> <span class="p">=</span> <span class="nx">slice</span><span class="p">(</span><span class="k">data</span><span class="p">.</span><span class="nx">aws_availability_zones</span><span class="p">.</span><span class="nx">available</span><span class="p">.</span><span class="nx">names</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="nx">tags</span> <span class="p">=</span> <span class="p">{</span>
            <span class="nx">Blueprint</span> <span class="p">=</span> <span class="kd">local</span><span class="p">.</span><span class="nx">name</span>
            <span class="nx">GithubRepo</span> <span class="p">=</span><span class="s2">"github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform"</span> <span class="c1">#use forked or upstream repo</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">#---------------------------------------------------------------</span>
    <span class="c1"># EKS Blueprints</span>
    <span class="c1">#---------------------------------------------------------------</span>

    <span class="k">module</span> <span class="s2">"eks_blueprints"</span> <span class="p">{</span>
    <span class="nx">source</span> <span class="p">=</span> <span class="s2">"../../.."</span> <span class="c1"># location of 'parent module' in the source code hierarchy</span>

    <span class="nx">cluster_name</span> <span class="p">=</span> <span class="kd">local</span><span class="p">.</span><span class="nx">name</span>

    <span class="c1"># Customization of K8s API version</span>
    <span class="c1"># K8s API version for data and compute planes</span>
    <span class="nx">cluster_version</span> <span class="p">=</span> <span class="s2">"1.24"</span>

    <span class="nx">vpc_id</span> <span class="p">=</span> <span class="k">module</span><span class="p">.</span><span class="nx">vpc</span><span class="p">.</span><span class="nx">vpc_id</span>
    <span class="nx">private_subnet_ids</span> <span class="p">=</span> <span class="k">module</span><span class="p">.</span><span class="nx">vpc</span><span class="p">.</span><span class="nx">private_subnets</span>

    <span class="nx">managed_node_groups</span> <span class="p">=</span> <span class="p">{</span>
        <span class="nx">mg_5</span> <span class="p">=</span> <span class="p">{</span>
            <span class="nx">node_group_name</span> <span class="p">=</span> <span class="s2">"managed-ondemand"</span>
            <span class="nx">instance_types</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"m5.large"</span><span class="p">]</span>
            <span class="nx">subnet_ids</span> <span class="p">=</span> <span class="k">module</span><span class="p">.</span><span class="nx">vpc</span><span class="p">.</span><span class="nx">private_subnets</span>

            <span class="nx">desired_size</span> <span class="p">=</span> <span class="mi">3</span>
            <span class="nx">max_size</span> <span class="p">=</span> <span class="mi">5</span>
            <span class="nx">min_size</span> <span class="p">=</span> <span class="mi">2</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">tags</span> <span class="p">=</span> <span class="kd">local</span><span class="p">.</span><span class="nx">tags</span>
    <span class="p">}</span>

    <span class="c1"># EKS Add-ons configuration</span>
    <span class="k">module</span> <span class="s2">"eks_blueprints_kubernetes_addons"</span> <span class="p">{</span>
        <span class="c1"># location of 'parent module' in the source code hierarchy</span>
        <span class="nx">source</span> <span class="p">=</span> <span class="s2">"../../../modules/kubernetes-addons"</span> 

        <span class="nx">eks_cluster_id</span> <span class="p">=</span> <span class="k">module</span><span class="p">.</span><span class="nx">eks_blueprints</span><span class="p">.</span><span class="nx">eks_cluster_id</span>
        <span class="nx">eks_cluster_endpoint</span> <span class="p">=</span> <span class="k">module</span><span class="p">.</span><span class="nx">eks_blueprints</span><span class="p">.</span><span class="nx">eks_cluster_endpoint</span>
        <span class="nx">eks_oidc_provider</span> <span class="p">=</span> <span class="k">module</span><span class="p">.</span><span class="nx">eks_blueprints</span><span class="p">.</span><span class="nx">oidc_provider</span>
        <span class="nx">eks_cluster_version</span> <span class="p">=</span> <span class="k">module</span><span class="p">.</span><span class="nx">eks_blueprints</span><span class="p">.</span><span class="nx">eks_cluster_version</span>

        <span class="c1"># Enable installation of argo-cd add-on via HELM</span>
        <span class="nx">enable_argocd</span> <span class="p">=</span> <span class="kc">true</span>

        <span class="c1"># Set default ArgoCD Admin Password using SecretsManager with Helm Chart set_sensitive values.</span>
        <span class="nx">argocd_helm_config</span> <span class="p">=</span> <span class="p">{</span>
            <span class="nx">set_sensitive</span> <span class="p">=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="nx">name</span> <span class="p">=</span> <span class="s2">"configs.secret.argocdServerAdminPassword"</span>
                    <span class="nx">value</span> <span class="p">=</span> <span class="nx">bcrypt_hash</span><span class="p">.</span><span class="nx">argo</span><span class="p">.</span><span class="nx">id</span>
                <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><ol style="counter-reset:none"><li>Initialize Terraform from the directory where source code is located:</ol><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>examples/gitops/argocd
terraform init
</code></pre></div></div><ol style="counter-reset:none"><li>Verify resources to be created by this blueprint:</ol><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform plan
</code></pre></div></div><ol style="counter-reset:none"><li>Apply staged Terraform resources to AWS environment:</ol><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform apply
</code></pre></div></div><p>(Enter <em>yes</em> at command prompt to apply or use <code class="language-plaintext highlighter-rouge">terraform apply-auto-approve</code> to bypass that question).</p><h3 id="validation-1"> Validation</h3><p>The following command will update the <em>kubeconfig</em> Kubernetes context configuration file on user’s machine and allow to interact with the EKS Cluster using <code class="language-plaintext highlighter-rouge">kubectl</code> client to validate the deployment.</p><ol><li>Run <code class="language-plaintext highlighter-rouge">update-kubeconfig</code> command which will update the local K8s configuration file by adding a context corresponding to newly created cluster:</ol><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws eks <span class="nt">--region</span> &lt;REGION&gt; update-kubeconfig <span class="nt">--name</span> &lt;CLUSTER_NAME&gt;
</code></pre></div></div><ol style="counter-reset:none"><li>List out the pods running currently in the <em>argocd</em> and other K8s namespaces:</ol><figure><img class="docimage" src="images/eks-provision-terraform/terraform-Figure4.png" alt="" /></figure><p>(Names of pods in different K8s namespaces reflect corresponding deployed EKS add-ons)</p><ol style="counter-reset:none"><li>You can test access to ArgoCD Server UI by running the following commands:</ol><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl port-forward svc/argo-cd-argocd-server 8080:443 <span class="nt">-n</span> argocd
</code></pre></div></div><blockquote><p>Then, open browser and navigate to <a href="http://localhost:8080/" target="_blank">http://localhost:8080/</a>. The login Username should be <em>admin</em>. Also, permanent Argo CD admin UI service URL can be obtained by examining services running in the <code class="language-plaintext highlighter-rouge">argocd</code> namespace by running the following command:</p></blockquote><figure><img class="docimage" src="images/eks-provision-terraform/terraform-Figure5.png" alt="" /></figure><blockquote><p>and changing type of ‘argo-cd-argocd-server’ to LoadBalancer:</p></blockquote><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl patch svc argo-cd-argocd-server <span class="nt">-n</span> argocd <span class="nt">-p</span> <span class="s1">'{"spec":{"type": "LoadBalancer"}}'</span>
</code></pre></div></div><blockquote><p>which can be confirmed by running the following command:</p></blockquote><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get svc <span class="nt">-n</span> argocd | <span class="nb">grep </span>argo-cd-argocd-server

argo-cd-argocd-server LoadBalancer 172.20.251.159
XXXXXXXXXXXXXXXXXXXXXXXXX.us-west-2.elb.amazonaws.com
80:31120/TCP,443:30200/TCP 12d
</code></pre></div></div><blockquote><p>Argo CD endpoint URL is listed as an attribute of <code class="language-plaintext highlighter-rouge">argo-cd-argocd-server</code> and should appear like shown in the screenshot below:</p></blockquote><figure><img class="docimage" src="images/eks-provision-terraform/terraform-Figure1.png" alt="architecture" /></figure><p>Figure 1 Argo CD endpoint URL</p><blockquote><p>The Argo CD admin password will be the generated password by the <code class="language-plaintext highlighter-rouge">random_password</code> resource, stored in AWS Secrets Manager.</p><p>You can easily retrieve the password by running the following command:</p></blockquote><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws secretsmanager get-secret-value <span class="nt">--secret-id</span> &lt;SECRET_NAME&gt; <span class="nt">--region</span> &lt;REGION&gt;
</code></pre></div></div><blockquote><p>Replace &lt; SECRET_NAME &gt; with the name of the secret name (by default it should be <code class="language-plaintext highlighter-rouge">'argocd'</code>) and make sure to replace &lt; REGION &gt; with the Region where the EKS Blueprint is deployed.</p><p>An example of retrieving the secret from the <code class="language-plaintext highlighter-rouge">SecretString</code> value is shown below:</p><p>Run this command:</p></blockquote><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws secretsmanager get-secret-value <span class="nt">--secret-id</span> argocd <span class="nt">--region</span> us-west-2
</code></pre></div></div><p>which should return an output like:</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"ARN"</span><span class="p">:</span><span class="w">
    </span><span class="s2">"arn:aws:secretsmanager:us-west-2:XXXXXXXXX:secret:argocd-7Mz04Y"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"argocd"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"VersionId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"88E3BA7E-7A2E-4129-A87C-1794E1CAD627"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"SecretString"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXXXXXXXXXXXXXX"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"VersionStages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"AWSCURRENT"</span><span class="w">
        </span><span class="p">],</span><span class="w">
    </span><span class="nl">"CreatedDate"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2022-12-19T12:05:12.458000-08:00"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p>Argo CD EKS blueprint comes with a number of pre-defined Argo CD <a href="https://argo-cd.readthedocs.io/en/stable/core_concepts/" target="_blank">applications</a> configured and mapped for deployment into the local EKS cluster. Please refer to Argo CD <a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/app-any-namespace/" target="_blank">documentation</a> for details on how to work with applications using that GitOps platform. An example of such applications in Argo CD UI is shown below:</p><figure><img class="docimage" src="images/eks-provision-terraform/terraform-Figure2.png" alt="" /></figure><p>Figure 2 Displays how Argo CD applications are configured in an EKS cluster</p><p><strong>Cleanup</strong></p><p>To tear down and remove all the resources created in this example, you need to ensure that all Argo CD applications are properly deleted from the cluster. This can be achieved in multiple ways:</p><ol><li><p>Disabling the <code class="language-plaintext highlighter-rouge">argocd_applications</code> configuration in the code locally and running <code class="language-plaintext highlighter-rouge">terraform apply</code> command again</p><li><p>Deleting the apps using <code class="language-plaintext highlighter-rouge">argocd</code> <a href="https://argo-cd.readthedocs.io/en/stable/user-guide/app_deletion/#deletion-using-argocd" target="_blank">cli</a> or UI</p></ol><p>The example below shows how the Argo CD applications are configured and managed by that platform in an EKS cluster that can be deleted by selecting the <strong>Delete</strong> buttons:</p><figure><img class="docimage" src="images/eks-provision-terraform/terraform-Figure3.png" alt="" /></figure><p>Figure 3 Displays how Argo CD applications can be deleted from the EKS cluster</p><ol style="counter-reset:none"><li>Deleting the apps using <code class="language-plaintext highlighter-rouge">kubectl</code> following <a href="https://argo-cd.readthedocs.io/en/stable/user-guide/app_deletion/#deletion-using-kubectl" target="_blank">ArgoCD guidance</a></ol><p>After application-level cleanup, you can delete the Terraform provisioned resources as follows:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform destroy <span class="nt">-target</span><span class="o">=</span>module.eks_blueprints_kubernetes_addons <span class="nt">-auto-approve</span>
terraform destroy <span class="nt">-target</span><span class="o">=</span>module.eks_blueprints <span class="nt">-auto-approve</span>
<span class="c"># Finally destroy all additional resources not provisioned by above TF modules</span>
terraform destroy <span class="nt">-auto-approve</span>
</code></pre></div></div><h2 id="running-apache-spark-on-eks-terraform-blueprint"> <a href="#running-apache-spark-on-eks-terraform-blueprint" class="anchor-heading" aria-labelledby="running-apache-spark-on-eks-terraform-blueprint"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Running Apache Spark on EKS Terraform Blueprint</h2><h3 id="prerequisites-2"> Prerequisites</h3><p>Ensure that the following tools are installed locally:</p><ol><li><p><a href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html" target="_blank">aws cli</a></p><li><p><a href="https://kubernetes.io/docs/tasks/tools/" target="_blank">kubectl</a></p><li><p><a href="https://learn.hashicorp.com/tutorials/terraform/install-cli" target="_blank">terraform</a></p></ol><h3 id="minimum-iam-policy-2"> Minimum IAM Policy</h3><p class="note">The policy resource is set as * to allow all resources, this is not a recommended practice.</p><p>Minimum IAM policy is documented <a href="#iam-policies-and-roles">above</a> and can be found <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-data-apps-amazon-elastic-kubernetes-service-using-terraform/blob/main/analytics/terraform/spark-k8s-operator/examples/min-iam-policy.json" target="_blank">here</a> – it is automatically bootstrapped to EKS clusters provisioned by blueprint</p><h3 id="deployment-2"> Deployment</h3><p>To provision the EKS Cluster with Apache Spark and Apache Spark History server components and application workloads, follow these steps:</p><ol><li>Clone EKS blueprints <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-data-apps-amazon-elastic-kubernetes-service-using-terraform" target="_blank">data on EKS</a> source code repository (where Apache Spark EKS add-on blueprint is hosted) locally:</ol><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-data-apps-amazon-elastic-kubernetes-service-using-terraform.git
</code></pre></div></div><ol style="counter-reset:none"><li>Initialize Terraform:</ol><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>analytics/terraform/spark-k8s-operator
terraform init
</code></pre></div></div><ol style="counter-reset:none"><li>Verify AWS and EKS K8s resources to be created by this blueprint</ol><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform plan
</code></pre></div></div><ol style="counter-reset:none"><li>Apply staged resources to AWS environment</ol><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform apply
</code></pre></div></div><p>(Enter <em>yes</em> at command prompt to apply)</p><h3 id="validation-2"> Validation</h3><p>The following command will update the <code class="language-plaintext highlighter-rouge">kubeconfig</code> client configuration file on the user’s machine and allow it to interact with the EKS Cluster using <code class="language-plaintext highlighter-rouge">kubectl</code> to validate the deployment.</p><p>Run <code class="language-plaintext highlighter-rouge">update-kubeconfig</code> command:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws eks <span class="nt">--region</span> &lt;REGION&gt; update-kubeconfig <span class="nt">--name</span> &lt;CLUSTER_NAME&gt;
</code></pre></div></div><p><strong>Running Test Apache Spark Job from a Driver pod</strong></p><ol><li>First, you need to create a Kubernetes  Service account that will have a role that allows driver pods to create pods and services under the default <a href="https://kubernetes.io/docs/admin/authorization/rbac/" target="_blank">RBAC</a> policiesas explained in the <a href="https://spark.apache.org/docs/latest/running-on-kubernetes.html#cluster-mode" target="_blank">Documentation</a></ol><p>An example of such commands for ‘default’ namespace is shown below:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create serviceaccount spark
kubectl create clusterrolebinding spark-role <span class="nt">--clusterrole</span><span class="o">=</span>edit <span class="nt">--serviceaccount</span><span class="o">=</span>default:spark <span class="nt">--namespace</span><span class="o">=</span>default
</code></pre></div></div><p>You can verify whether necessary permissions were granted to the created Service account by running the following command:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl auth can-i create pods <span class="nt">-n</span> default <span class="nt">--as</span> system:serviceaccount:default:spark
</code></pre></div></div><p>which should produce an output:<code class="language-plaintext highlighter-rouge">yes</code></p><ol style="counter-reset:none"><li>Now we need to determine a URL of Kubernetes master node to use later for Spark job submission. The command below returns a URL of master node:</ol><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl cluster-info
</code></pre></div></div><p>that should produce an output including entry like (partially masked for privacy):</p><div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">Kubernetes control plane is running at
https://XXXXXXXXXXXXXXXXXXXXXXXXX.gr7.us-east-2.eks.amazonaws.com
</span></code></pre></div></div><ol style="counter-reset:none"><li>With API endpoint determined and service accounts configured, we can run a test Spark job using an instance of the apache/spark image. The command below will create a pod instance from which we can launch test jobs.</ol><p><em>Creating a pod to deploy a cluster in client mode, Apache Spark applications is sometimes referred to as deploying a “jump,” “edge,” or “bastian” pod. It’s a variant of deploying a <a href="https://en.wikipedia.org/wiki/Bastion_host" target="_blank">Bastion Host</a>, where high-value or sensitive resources run in one environment and the bastion serves as a proxy.</em></p><p>An example command below creates a jump pod using the Spark driver container based on the ‘apache/spark’ container image that is using the previously created ‘spark’ service account:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl run spark-test-docker <span class="nt">--overrides</span><span class="o">=</span><span class="s1">'{"spec" {"serviceAccount":"spark"}}'</span> <span class="nt">-it</span> <span class="nt">--image</span><span class="o">=</span>apache/spark <span class="nt">--</span> /bin/bash
</code></pre></div></div><p>The <code class="language-plaintext highlighter-rouge">kubectl</code> command creates a deployment and driver pod, and will drop into its <em>bash</em> shell when the pod becomes available. <em>The remainder of the commands in this section will use this shell.</em></p><ol style="counter-reset:none"><li>Apache’s Spark image distribution contains an example program that can be used to calculate the number <a href="https://en.wikipedia.org/wiki/Pi" target="_blank">Pi</a>. Since it works without any input, it is useful for running tests. We can check that the Spark cluster is configured correctly by submitting this application to the cluster. Apache Spark commands are submitted using <code class="language-plaintext highlighter-rouge">spark-submit utility.</code> In the container images created above<em>,</em> <code class="language-plaintext highlighter-rouge">spark-submit</code> can be found in the <em>/opt/spark/bin folder.</em></ol><p><code class="language-plaintext highlighter-rouge">spark-submit</code> command options can be quite complicated, please see <a href="https://spark.apache.org/docs/latest/running-on-kubernetes.html#cluster-mode" target="_blank">documentation</a> for all option values . For that reason, let’s configure a set of environment variables with important runtime parameters. <em>While we define these directly here, in Spark applications they can be injected from a ConfigMap or as part of the pod/deployment manifest:</em></p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Define environment variables with K8s namespace, accounts and auth parameters</span>
<span class="nb">export </span><span class="nv">SPARK_NAMESPACE</span><span class="o">=</span>default
<span class="nb">export </span><span class="nv">SA</span><span class="o">=</span>spark
<span class="nb">export </span><span class="nv">K8S_CACERT</span><span class="o">=</span>/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
<span class="nb">export </span><span class="nv">K8S_TOKEN</span><span class="o">=</span>/var/run/secrets/kubernetes.io/serviceaccount/token

<span class="c"># Docker runtime image and driver pod name</span>
<span class="nb">export </span><span class="nv">DOCKER_IMAGE</span><span class="o">=</span>apache/spark
<span class="nb">export </span><span class="nv">SPARK_DRIVER_NAME</span><span class="o">=</span>spark-test-pi
</code></pre></div></div><ol style="counter-reset:none"><li>The example command below submits Spark job to the cluster referenced by –master option. It will deploy in “<em>cluster</em>” mode and <strong>reference</strong> the <code class="language-plaintext highlighter-rouge">spark-examples</code> JAR included with the specified container image. We tell Apache Spark which program within the JAR to execute by defining the –class option. In this case, we wish to run the <code class="language-plaintext highlighter-rouge">org.apache.spark.examples.SparkPi</code> Java class:</ol><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># spark-submit command</span>

/opt/spark/bin/spark-submit <span class="nt">--name</span> <span class="nv">$SPARK_DRIVER_NAME</span> <span class="se">\</span>
    <span class="nt">--master</span> k8s://https://XXXXXXXXXXXXXXXXXXX.gr7.us-east-2.eks.amazonaws.com:443 <span class="se">\</span>
    <span class="nt">--deploy-mode</span> cluster <span class="se">\</span>
    <span class="nt">--class</span> org.apache.spark.examples.SparkPi <span class="se">\</span>
    <span class="nt">--conf</span> spark.kubernetes.driver.pod.name<span class="o">=</span><span class="nv">$SPARK_DRIVER_NAME</span> <span class="se">\</span>
    <span class="nt">--conf</span> spark.kubernetes.authenticate.subdmission.caCertFile<span class="o">=</span><span class="nv">$K8S_CACERT</span> <span class="se">\</span>
    <span class="nt">--conf</span> spark.kubernetes.authenticate.submission.oauthTokenFile<span class="o">=</span><span class="nv">$K8S_TOKEN</span> <span class="se">\</span>
    <span class="nt">--conf</span> spark.kubernetes.authenticate.driver.serviceAccountName<span class="o">=</span><span class="nv">$SA</span> <span class="se">\</span>
    <span class="nt">--conf</span> spark.kubernetes.namespace<span class="o">=</span><span class="nv">$SPARK_NAMESPACE</span> <span class="se">\</span>
    <span class="nt">--conf</span> spark.executor.instances<span class="o">=</span>2 <span class="se">\</span>
    <span class="nt">--conf</span> spark.kubernetes.container.image<span class="o">=</span><span class="nv">$DOCKER_IMAGE</span> <span class="se">\</span>
    <span class="nt">--conf</span> spark.kubernetes.container.image.pullPolicy<span class="o">=</span>Always <span class="se">\</span>
    <span class="nb">local</span>:///opt/spark/examples/jars/spark-examples_2.12-3.3.2.jar 100000
</code></pre></div></div><p><em>NOTES:</em></p><ul><li><p><em>The Kubernetes API is available within the cluster within the <code class="language-plaintext highlighter-rouge">default</code> namespace and should be used in the <code class="language-plaintext highlighter-rouge">master</code> option. If Kubernetes DNS is available, API can be accessed via namespace URL (<code class="language-plaintext highlighter-rouge">https://kubernetes.default:443</code> to be used the example above). The <code class="language-plaintext highlighter-rouge">k8s://https://</code>form of the URL - this is <strong>not</strong> a typo, the <code class="language-plaintext highlighter-rouge">k8s://</code> prefix is how Spark determines the provider type.</em></p><li><p><em>The <code class="language-plaintext highlighter-rouge">local://</code> path of the <code class="language-plaintext highlighter-rouge">jar</code> above references location of the file in the executor container image, not on the jump pod that we used to submit the job. Both the driver and executors rely on that path in order to find the program implementation and start Spark tasks.</em></p></ul><ol style="counter-reset:none"><li>If you watch the pod list while the job is running using <code class="language-plaintext highlighter-rouge">kubectl get pods,</code> you should see a “driver” pod initialized with the name provided in the <code class="language-plaintext highlighter-rouge">SPARK_DRIVER_NAME</code> option. It will launch executor pods that actually perform the work while staying in “Running” status and get deleted upon job completion . When the Spark Job finishes running, the driver pod changes into “Completed” status. You can review status of these pods and retrieve Spark job results from the pod logs using command like:</ol><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># monitor driver and executor pods initialized by Spark job submission:</span>

kubectl get pods <span class="nt">-n</span> default <span class="nt">-w</span>
</code></pre></div></div><p>Which should give an output like:</p><figure><img class="docimage" src="images/eks-provision-terraform/terraform-Figure6.png" alt="" /></figure><p>You can also retrieve results of Spark Job execution running command like:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Retrieve the results of the program from the cluster</span>

kubectl logs <span class="nt">-f</span> <span class="nv">$SPARK_DRIVER_NAME</span>
</code></pre></div></div><p>Toward the end of the “driver” pod log, you should see a result line similar to example shown below:</p><div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">23/02/21 02:05:31 INFO TaskSetManager: Finished task 99998.0 in stage 0.0 (TID 99998) in 27 ms on 10.1.142.42 (executor 2) (99999/100000)
23/02/21 02:05:31 INFO TaskSetManager: Finished task 99999.0 in stage 0.0 (TID 99999) in 25 ms on 10.1.46.210 (executor 1) (100000/100000)
23/02/21 02:05:31 INFO TaskSchedulerImpl: Removed TaskSet 0.0, whose tasks have all completed, from pool
23/02/21 02:05:31 INFO DAGScheduler: ResultStage 0 (reduce at SparkPi.scala:38) finished in 153.114 s
23/02/21 02:05:31 INFO DAGScheduler: Job 0 is finished. Cancelling potential speculative or zombie tasks for this job
23/02/21 02:05:31 INFO TaskSchedulerImpl: Killing all running tasks in stage 0: Stage finished
23/02/21 02:05:31 INFO DAGScheduler: Job 0 finished: reduce at SparkPi.scala:38, took 153.531012 s
**Pi is roughly 3.1416237160019795**
</span></code></pre></div></div><p><strong>Pre-requisites for running Kubernetes Spark Application examples</strong></p><p>There are examples for Apache Spark Applications configurations that can be launched directly as K8s objects located <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-data-apps-amazon-elastic-kubernetes-service-using-terraform/tree/main/analytics/terraform/spark-k8s-operator/examples" target="_blank">here</a>. Every <em>yaml</em> file in the <em>examples</em> folder has pre-requisite requirements mentioned at the top of the file in the commented section. See an example for this configuration <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-data-apps-amazon-elastic-kubernetes-service-using-terraform/blob/main/analytics/terraform/spark-k8s-operator/examples/benchmark/tpcds-benchmark-1t.yaml" target="_blank">here</a>.</p><p class="note">This example requires the following prerequisites before executing the jobs:</p><ol><li><p>Ensure <code class="language-plaintext highlighter-rouge">spark-team-a</code> name space exists</p><li><p>replace <code class="language-plaintext highlighter-rouge">&lt; ENTER_YOUR_BUCKET &gt;</code> with your bucket name</p><li><p>Ensure you run <code class="language-plaintext highlighter-rouge">"analytics/spark-k8s-operator/spark-samples/tpcds-benchmark-data-generation-1t.yaml"</code> to generate the INPUT data in the Amazon S3 bucket and update INPUT argument <code class="language-plaintext highlighter-rouge">("s3a://&lt;ENTER_YOUR_BUCKET&gt;/TPCDS-TEST-1T/catalog_sales/")</code> path in the below yaml</p></ol><p>Please follow the instructions (for example: create an Amazon S3 bucket with necessary permissions and specify its name in the section of the application configuration file) in order to run the examples using <code class="language-plaintext highlighter-rouge">kubectl apply -f &lt;descriptor&gt;.yaml</code> syntax</p><p><strong>Cleanup</strong></p><p>To clean up your environment, first delete all Apache Spark applications and then destroy the Terraform modules in reverse order of their deployment.</p><p>Destroy the Kubernetes Add-ons, EKS cluster with Node groups and VPC as follows:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform destroy <span class="nt">-target</span><span class="o">=</span><span class="s2">"module.eks_blueprints_kubernetes_addons"</span> <span class="nt">-auto-approve</span>
terraform destroy <span class="nt">-target</span><span class="o">=</span><span class="s2">"module.eks_blueprints"</span> <span class="nt">-auto-approve</span>
terraform destroy <span class="nt">-target</span><span class="o">=</span><span class="s2">"module.vpc"</span> <span class="nt">-auto-approve</span>
</code></pre></div></div><p>Finally, destroy any additional resources that are not in the above modules:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform destroy <span class="nt">-auto-approve</span>
</code></pre></div></div><h2 id="support-and-troubleshooting"> <a href="#support-and-troubleshooting" class="anchor-heading" aria-labelledby="support-and-troubleshooting"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Support and Troubleshooting</h2><h3 id="support--feedback"> Support &amp; Feedback</h3><p>EKS Terraform Blueprints is an <a href="https://opensource.com/resources/what-open-source" target="_blank">Open-Source</a> project maintained by AWS Solution Architects. It is not part of an AWS Service and support is provided with best-effort by AWS Solution Architects and the EKS Blueprints community.</p><p>To post feedback, submit feature ideas or report bugs, you can use the <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-data-apps-amazon-elastic-kubernetes-service-using-terraform/issues" target="_blank">Issues section</a> of the project GitHub repository (and the link on the Guidance).</p><p>If you are interested in contributing to EKS Blueprints, you can follow the <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform/blob/main/CONTRIBUTING.md" target="_blank">Contribution guide.</a></p><h3 id="version-requirements"> Version Requirements</h3><p>This version of EKS Blueprint requires the following version of core tools</p><div class="table-wrapper"><table><thead><tr><th><strong>Name</strong><th><strong>Version</strong><tbody><tr><td><a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform#requirement_terraform" target="_blank">terraform</a><td>&gt;= 1.0.0<tr><td><a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform#requirement_aws" target="_blank">aws</a><td>&gt;= 3.72<tr><td><a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform#requirement_helm" target="_blank">helm</a><td>&gt;= 2.4.1<tr><td><a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform#requirement_http" target="_blank">http</a><td>2.4.1<tr><td><a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform#requirement_kubectl" target="_blank">kubectl</a><td>&gt;= 1.14<tr><td><a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform#requirement_kubernetes" target="_blank">kubernetes</a><td>&gt;= 2.10<tr><td><a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform#requirement_local" target="_blank">local</a><td>&gt;= 2.1</table></div><p>and Service providers:</p><div class="table-wrapper"><table><thead><tr><th><strong>Name</strong><th><strong>Version</strong><tbody><tr><td><a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform#provider_aws" target="_blank">aws</a><td>&gt;= 3.72<tr><td><a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform#provider_http" target="_blank">http</a><td>2.4.1<tr><td><a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform#provider_kubernetes" target="_blank">kubernetes</a><td>&gt;= 2.10</table></div><h3 id="customization"> Customization</h3><p>EKS Terraform Blueprints are highly customizable. Versions of core components from Kubernetes API version, to AWS services parameters such as: target AWS region, VPC CIDR range, name, AMI instance type, and range of node pool for compute plane can all be customized.</p><p>This Guidance has been successfully tested with values of those parameters used in the sample code in the GitHub <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform" target="_blank">repository</a> for “New VPC” and “Argo CD Add-on” and this <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-data-apps-amazon-elastic-kubernetes-service-using-terraform" target="_blank">repository</a> for Spark Add-on use cases, with an exception of <code class="language-plaintext highlighter-rouge">local.region</code> parameter that was set to the AWS Region with the most available resources.</p><p>You may specify different values for customization parameters. Be aware of your AWS environment topology, resources, and use values that make sense for that environment.</p><p>A full list of Terraform <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform#inputs" target="_blank">input</a> and <a href="https://github.com/aws-solutions-library-samples/guidance-for-automated-provisioning-of-amazon-elastic-kubernetes-service-using-terraform#outputs" target="_blank">output</a> parameters that are used for Blueprint customization can be found in the Project repository.</p><h3 id="troubleshooting"> Troubleshooting</h3><p>Terraform is a command-line tool that generates extensive logs when commands are executed. If Blueprint deployment fails for some reason (usually during execution of terraform apply command, see <a href="#running-argo-cd-eks-terraform-blueprint">above</a> for details) you can find detailed error messages in the log displayed on your console such as shown below:</p><div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">Error: failed creating IAM Role
(eks-cluster-with-new-vpc-aws-node-irsa): EntityAlreadyExists: Role with
name eks-cluster-with-new-vpc-aws-node-irsa already exists.
│  status code: 409, request id: c29d95fb-b206-4121-bdda-953be12209ef

│   with
module.eks_blueprints_kubernetes_addons.module.aws_vpc_cni[0].module.irsa_addon[0].aws_iam_role.irsa[0],
│   on ../../modules/irsa/main.tf line 35, in resource "aws_iam_role" "irsa":

│   35: resource "aws_iam_role" "irsa" {

│ Error: unexpected EKS Add-On (eks-cluster-with-new-vpc:coredns) state
returned during creation: timeout while waiting for state to become
'ACTIVE' (last state: 'DEGRADED', timeout: 20m0s)
│ [WARNING] Running terraform apply again will remove the kubernetes
add-on and attempt to create it again effectively purging previous
add-on configuration

│   with module.eks_blueprints_kubernetes_addons.module.aws_coredns[0].aws_eks_addon.coredns[0],
│   on ../../modules/kubernetes-addons/aws-coredns/main.tf line 12, in resource "aws_eks_addon" "coredns":
│   12: resource "aws_eks_addon" "coredns" {

│Error: error creating IAM Policy eks-cluster-with-new-vpc-aws-ebs-csi-driver-irsa: EntityAlreadyExists: A policy called eks-cluster-with-new-vpc-aws-ebs-csi-driver-irsa already exists. Duplicate names are not ||   allowed.
│   status code: 409, request id: a1d15c7f-24fe-4e1f-966a-c0b97191d5a3

│ with
module.eks_blueprints_kubernetes_addons.module.aws_ebs_csi_driver[0].aws_iam_policy.aws_ebs_csi_driver[0],
│ on ../../modules/kubernetes-addons/aws-ebs-csi-driver/main.tf line 91,
in resource "aws_iam_policy" "aws_ebs_csi_driver":
│ 91: resource "aws_iam_policy" "aws_ebs_csi_driver" {

</span></code></pre></div></div><p>Log files usually point to a Terraform module name and line of its script where error occurred, allowing you to examine the specified parameters and make necessary changes, then try deployment again.</p><p>In the example above, an EKS cluster named <code class="language-plaintext highlighter-rouge">eks-cluster-with-new-vpc</code> was deployed to another Region, with generated IAM roles and policies objects based on that cluster name that are “globally” scoped. That caused the errors above. The errors were fixed by changing the value assigned to the parameter <code class="language-plaintext highlighter-rouge">cluster_name = "${local.cluster_name1}-test1"</code> in the <code class="language-plaintext highlighter-rouge">main.tf locals</code> module. This ensured that the cluster, the related role, and the policy names would be unique.</p><hr><footer><p><a href="#top" id="back-to-top">Back to top</a></p></footer></div></div><div class="search-overlay"></div></div>

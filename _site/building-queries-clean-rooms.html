<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><title>Guidance for Building Queries in AWS Clean Rooms | AWS Solutions Library Samples</title><link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="shortcut icon" href="/images/aws.png"><body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-copy" viewBox="0 0 16 16"><title>Copy</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"><title>Copied</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg><div class="side-bar"><div class="site-header"> <a href="/index.html" class="site-title lh-tight"> AWS Solutions Library Samples </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a></div><nav aria-label="Main" id="site-nav" class="site-nav"><ul style="padding-right: 10px;font-weight: 600;">Guidance for Building Queries in AWS Clean Rooms</ul><hr><ul class="nav-list"><li class="nav-list-item active"> <a href="#" class="nav-list-link">Get started</a><li class="nav-list-item active"> <a href="#scenario" class="nav-list-link">Scenario</a><li class="nav-list-item active"> <a href="#data-prep" class="nav-list-link">Data Prep</a><li class="nav-list-item active"> <a href="#querying-data-within-the-aws-data-clean-rooms" class="nav-list-link">Querying Data within the AWS Data Clean Rooms</a><li class="nav-list-item active"> <a href="#use-of-amazon-athena" class="nav-list-link">Use of Amazon Athena</a><li class="nav-list-item active"> <a href="#use-of-amazon-quicksight" class="nav-list-link">Use of Amazon QuickSight</a><li class="nav-list-item active"> <a href="#example-scenario-and-queries" class="nav-list-link">Example Scenario and Queries</a></ul><ul class="nav-list"></ul></nav></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search AWS Solutions Library Samples" aria-label="Search AWS Solutions Library Samples" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="//github.com/just-the-docs/just-the-docs" class="site-button" > Just the Docs on GitHub </a></ul></nav></div><div id="main-content-wrap" class="main-content-wrap"><div id="main-content" class="main-content" role="main"><div class="post-header"><h1 class="post-title-main"> Guidance for Building Queries in AWS Clean Rooms</h1></div><p class=".fs-6 .fw-300"> <b>Summary:</b> This Guidance aims to help users getting started with AWS Clean Rooms collaboration. The reference architecture first illustrates how users can set up an AWS Data Clean Rooms data collaboration and prepare data. Then it illustrates how to use Amazon Athena and Amazon QuickSight for further analysis and visualization of the results produced as output of that cleanroom collaboration.</p><hr /><p>This Guidance aims to help users getting started with AWS Clean Rooms collaboration. The reference architecture first illustrates how users can set up an AWS Data Clean Rooms data collaboration and prepare data. Then it illustrates how to use Amazon Athena and Amazon QuickSight for further analysis and visualization of the results produced as output of that cleanroom collaboration.</p><h2 id="scenario"> <a href="#scenario" class="anchor-heading" aria-labelledby="scenario"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Scenario</h2><p>Customers (advertisers, publishers, data providers) use AWS Data Clean Rooms to collaborate on private data without exposing secure information between parties. A typical use case for AWS Data Clean Rooms is when two parties are collecting different pieces of data about overlapping end-users or customers, and the two parties want to generate insights from the overlap of these two datasets, without exposing the sensitive or Personally Identifiable Information (PII) attributes within their first party data. With AWS Data Clean Rooms, each data provider can control what data the consumer is able to view, query, and aggregate.</p><p>This Guidance demonstrates how a customer could prepare data for an AWS Data Clean Rooms collaboration, and set up an analytics and insights stack on AWS to investigate the results of queries exported from the collaboration on AWS. The reference architecture demonstrates how AWS Glue can be used to crawl data stored on Amazon Simple Storage Service (Amazon S3) to create data that can be accessed through the AWS Data Clean Rooms interface. Once data is joined and analyzed within the AWS Data Clean Rooms, query results can then be stored on Amazon S3 and accessed from Amazon Athena for further analysis and visualization.</p><h2 id="data-prep"> <a href="#data-prep" class="anchor-heading" aria-labelledby="data-prep"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Data Prep</h2><p>To utilize data within AWS Data Clean Rooms, it must first be added to an AWS Glue Data Catalog. This can be done manually or with the AWS Glue Crawler.</p><p>Preparing data and adding it to an AWS Glue Data Catalog must be done by each data provider contributing data to an AWS Data Clean Rooms collaboration.</p><p>Once data has been added to an AWS Glue Data Catalog, it can then be referenced within an AWS Data Clean Rooms collaboration and made available to the collaborators with custom analysis controls for each table.</p><h2 id="querying-data-within-the-aws-data-clean-rooms"> <a href="#querying-data-within-the-aws-data-clean-rooms" class="anchor-heading" aria-labelledby="querying-data-within-the-aws-data-clean-rooms"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Querying Data within the AWS Data Clean Rooms</h2><p>Once at least two datasets have been made available to the AWS Data Clean Rooms collaboration, SQL Queries can be performed to join the datasets, run aggregation analysis, and more. The results of each query are automatically stored in a configurable Amazon S3 location.</p><p>At the end of this Guidance, we will share an example scenario with sample data and queries that can be run within AWS Data Clean Rooms.</p><h2 id="use-of-amazon-athena"> <a href="#use-of-amazon-athena" class="anchor-heading" aria-labelledby="use-of-amazon-athena"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Use of Amazon Athena</h2><p>Amazon Athena allows you to query data stored in Amazon S3 with standard SQL syntax. With Athena, you can query the data where it sits, save your queries, and create views, which can then be used by Amazon QuickSight for visualization purposes.</p><p>In the reference architecture diagram, we can see how a user can utilize Amazon Athena to further query and analyze the results of an AWS Data Clean Rooms collaboration output. In much the same way that we prepared the data for use in the cleanroom, AWS Glue and Amazon Athena can work together to provide users easy access to a friendly SQL based user interface.</p><figure><img class="docimage" src="images/Building_queries/building-queries-clean-rooms.png" alt="architecture" /></figure><p>Figure 1 - Diagram for building queries in AWS Clean Rooms</p><h2 id="use-of-amazon-quicksight"> <a href="#use-of-amazon-quicksight" class="anchor-heading" aria-labelledby="use-of-amazon-quicksight"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Use of Amazon QuickSight</h2><p>Amazon QuickSight is a business intelligence tool that can help you easily create complex visualizations of the query results from an AWS Data Clean Rooms collaboration. You can use QuickSight to build dashboards that can be shared among your team, embedded on web pages, and set to automatically update whenever there is new data available.</p><p>The first time you navigate to Amazon QuickSight, you will need to select a plan and set up your organization name. You will also need to make some choices in terms of what Amazon QuickSight has access to. Select Athena and the Amazon S3 bucket where your AWS Data Clean Rooms query results are stored.</p><p>Once you have QuickSight enabled, you can connect Amazon Athena as a data source. Once connected to your data source, you can use QuickSight to build an analysis of your dataset.</p><h2 id="example-scenario-and-queries"> <a href="#example-scenario-and-queries" class="anchor-heading" aria-labelledby="example-scenario-and-queries"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example Scenario and Queries</h2><p>In this example, we will consider two entities who want to create a collaboration between their potentially overlapping datasets.</p><p>Entity A is an eCommerce company. This company has first party data pertaining to its customers in the form of email addresses, names, and physical addresses. This data has been collected over time through a variety of transactions, including website conversions.</p><p>Entity B is an advertiser. This company places ads on behalf of their clients and captures impression data, including email addresses, campaign IDs, and more.</p><p>Entity A has contracted with Entity B to run ad campaigns for their upcoming sale. Entity A would like to know details about the success of their campaigns with Entity B, but neither entity wants to compromise the privacy of their users. So, they use AWS Data Clean Rooms.</p><p>Entity A has data about their customers that looks something like the following:</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">fields</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"email_address"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"date_created"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"state"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"city"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"country"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"zip"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"first_name"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"last_name"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"birth_country"</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div><p>Entity A also has data about conversions on their website that looks like the following:</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">fields</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"email_address"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"date"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"creative_id"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"event_type"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"version"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"price"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"currency"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"transaction_id"</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div><p>Entity B has impression data from users who viewed ads placed by Entity A. This data looks like the following:</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">fields</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"email_address"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"date"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"creative_id"</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div><p>Once both entities have created a collaboration in AWS Data Clean Rooms and shared their tables, Entity A, the Data Consumer, can run queries like the following:</p><p><strong>1. Find the overlap between Entity A’s conversions data and Entity B’s impressions data:</strong></p><div start="2" class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">c</span><span class="p">.</span><span class="n">email_address</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">conversions</span> <span class="k">c</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">impressions</span> <span class="n">i</span>
<span class="k">ON</span> <span class="n">i</span><span class="p">.</span><span class="n">email_address</span> <span class="o">=</span> <span class="k">c</span><span class="p">.</span><span class="n">email_address</span>
</code></pre></div></div><p start="2"><strong>2. Overlap Analysis, segmented by Creative ID:</strong></p><div start="3" class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">c</span><span class="p">.</span><span class="n">email_address</span><span class="p">)</span> <span class="k">as</span> <span class="n">counts</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">creative_id</span>
<span class="k">FROM</span> <span class="n">conversions</span> <span class="k">c</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">impressions</span> <span class="n">i</span>
<span class="k">ON</span> <span class="n">i</span><span class="p">.</span><span class="n">email_address</span> <span class="o">=</span> <span class="k">c</span><span class="p">.</span><span class="n">email_address</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">c</span><span class="p">.</span><span class="n">creative_id</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">counts</span> <span class="k">DESC</span>
</code></pre></div></div><p start="3"><strong>3. Overlap Analysis, segmented by Price:</strong></p><div start="4" class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">c</span><span class="p">.</span><span class="n">email_address</span><span class="p">)</span> <span class="k">as</span> <span class="n">counts</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">price</span>
<span class="k">FROM</span> <span class="n">conversions</span> <span class="k">c</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">impressions</span> <span class="n">i</span>
<span class="k">ON</span> <span class="k">c</span><span class="p">.</span><span class="n">email_address</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">email_address</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">c</span><span class="p">.</span><span class="n">price</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">c</span><span class="p">.</span><span class="n">price</span> <span class="k">DESC</span>
</code></pre></div></div><p start="4"><strong>4. Audience Analysis:</strong></p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="k">c</span><span class="p">.</span><span class="n">email_address</span><span class="p">)</span> <span class="k">as</span> <span class="n">counts</span><span class="p">,</span> <span class="n">crm</span><span class="p">.</span><span class="n">c_birth_country</span>
<span class="k">FROM</span> <span class="n">impressions</span> <span class="n">i</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">conversions</span> <span class="k">c</span>
<span class="k">ON</span> <span class="k">c</span><span class="p">.</span><span class="n">email_address</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">email_address</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">customers</span> <span class="n">crm</span>
<span class="k">ON</span> <span class="k">c</span><span class="p">.</span><span class="n">email_address</span> <span class="o">=</span> <span class="n">crm</span><span class="p">.</span><span class="n">c_email_address</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">crm</span><span class="p">.</span><span class="n">c_birth_country</span>
</code></pre></div></div><hr><footer><p><a href="#top" id="back-to-top">Back to top</a></p></footer></div></div><div class="search-overlay"></div></div>
